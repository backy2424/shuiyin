import sys
import os
import io
import json
import platform
import time
from datetime import datetime
from docx import Document
from PyQt6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
                             QLabel, QPushButton, QSlider, QLineEdit, QFileDialog,
                             QListWidget, QListWidgetItem, QColorDialog, QDialog,
                             QDialogButtonBox, QMessageBox, QFormLayout, QPlainTextEdit, QProgressBar,
                             QComboBox, QMenu, QFrame, QGroupBox, QRadioButton)
from PyQt6.QtCore import Qt, QSize, QPoint, pyqtSignal, QThread, pyqtSlot
from PyQt6.QtGui import QPixmap, QImage, QIcon, QDragEnterEvent, QDropEvent, QAction, QColor, QMouseEvent, QPainter, \
    QFont
from PIL import Image, ImageDraw, ImageFont

# ä¾èµ–å®‰è£…å‘½ä»¤
# pip install python-docx PyQt6 Pillow

# --- é…ç½®ç®¡ç† ---
CONFIG_FILE = "wm_settings.json"
DEFAULT_CONFIG = {
    "text": "å†…éƒ¨æœºå¯†",
    "size_percent": 5,
    "opacity": 50,
    "angle": 45,
    "color": "#FF0000",  # é»˜è®¤çº¢è‰²ï¼ˆå±äºä¿ç•™é¢œè‰²ï¼‰
    "fill_mode": "single",
    "offset_x": 0,
    "offset_y": 0
}


def load_config():
    """åŠ è½½é…ç½®ï¼Œå…¼å®¹æ—§ç‰ˆæœ¬å¹¶è¡¥å…¨é»˜è®¤é”®"""
    config = DEFAULT_CONFIG.copy()
    if os.path.exists(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                loaded_config = json.load(f)
                for key in DEFAULT_CONFIG:
                    if key in loaded_config:
                        config[key] = loaded_config[key]
                return config
        except Exception as e:
            print(f"åŠ è½½é…ç½®å¤±è´¥: {e}ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®")
    return config


def save_config(config):
    """ä¿å­˜é…ç½®åˆ°æœ¬åœ°æ–‡ä»¶"""
    with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
        json.dump(config, f, ensure_ascii=False, indent=4)


# --- è¾…åŠ©å‡½æ•°ï¼šè·å–ç³»ç»Ÿé»˜è®¤å­—ä½“ ---
def get_default_font_path():
    """é€‚é…Windows/Mac/Linuxçš„ä¸­æ–‡å­—ä½“è·¯å¾„"""
    system = platform.system()
    if system == "Windows":
        fonts = ["msyh.ttc", "simhei.ttf", "arial.ttf"]
        for f in fonts:
            path = os.path.join("C:\\Windows\\Fonts", f)
            if os.path.exists(path):
                return path
    elif system == "Darwin":  # MacOS
        return "/System/Library/Fonts/PingFang.ttc"
    elif system == "Linux":
        return "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf"
    return None


# --- è¾…åŠ©å‡½æ•°ï¼šå›¾ç‰‡æ ¼å¼éªŒè¯ ---
def is_supported_image(path):
    """åˆ¤æ–­æ˜¯å¦ä¸ºæ”¯æŒçš„å›¾ç‰‡æ ¼å¼"""
    supported = ('.png', '.jpg', '.jpeg', '.bmp', '.gif', '.tiff')
    return path.lower().endswith(supported)


# --- è¾…åŠ©å‡½æ•°ï¼šå›¾ç‰‡æ ¼å¼å¤„ç†ï¼ˆPILå…¼å®¹+åç¼€ç»Ÿä¸€ï¼‰---
def get_image_format(path_or_pil):
    """
    è¿”å› (PILä¿å­˜æ ¼å¼, æ–‡ä»¶ååç¼€)
    - PILæ ¼å¼ï¼šJPEG/JPGç»Ÿä¸€ä¸º'JPEG'ï¼ˆç¬¦åˆPILè§„èŒƒï¼‰
    - åç¼€ï¼šç»Ÿä¸€ä¸º'jpg'ï¼ˆç”¨æˆ·ä¹ æƒ¯ï¼‰
    """
    if isinstance(path_or_pil, str):
        ext = os.path.splitext(path_or_pil)[1].lower()
        if ext in ['.jpeg', '.jpg']:
            return ('JPEG', 'jpg')
        elif ext == '.png':
            return ('PNG', 'png')
        elif ext == '.bmp':
            return ('BMP', 'bmp')
        elif ext == '.gif':
            return ('GIF', 'gif')
        elif ext == '.tiff':
            return ('TIFF', 'tiff')
        else:
            return ('JPEG', 'jpg')  # é»˜è®¤ fallback
    else:
        fmt = path_or_pil.format.upper() if path_or_pil.format else 'JPEG'
        return ('JPEG', 'jpg') if fmt == 'JPG' else (fmt, fmt.lower())


# --- æ ¸å¿ƒæ°´å°é€»è¾‘ï¼ˆä¿ç•™åŸæ ¼å¼+æ—‹è½¬ä¼˜åŒ–ï¼‰---
def apply_watermark_to_image(pil_image, settings):
    """æ·»åŠ æ°´å°ï¼Œæ”¯æŒè·³è¿‡æ°´å°ã€ä»¥æ–‡å­—ä¸­å¿ƒæ—‹è½¬ã€ä¿ç•™åŸæ ¼å¼"""
    # å¤„ç†è·³è¿‡æ°´å°çš„æƒ…å†µï¼ˆå…è®¸settingsä»…å«skip_watermarkï¼‰
    if isinstance(settings, dict) and settings.get('skip_watermark', False):
        return pil_image

    # è¡¥å…¨settingsä¸­ç¼ºå¤±çš„å¿…å¡«å­—æ®µï¼ˆä»é»˜è®¤é…ç½®è·å–ï¼‰
    full_settings = DEFAULT_CONFIG.copy()
    full_settings.update(settings)  # ç”¨ä¼ å…¥çš„settingsè¦†ç›–é»˜è®¤å€¼

    # è½¬ä¸ºRGBAä»¥ä¾¿å åŠ æ°´å°
    base_image = pil_image.convert("RGBA")
    width, height = base_image.size
    txt_layer = Image.new("RGBA", base_image.size, (255, 255, 255, 0))
    draw = ImageDraw.Draw(txt_layer)

    # å­—ä½“å¤§å°è®¡ç®—ï¼ˆæŒ‰å›¾ç‰‡å®½åº¦ç™¾åˆ†æ¯”ï¼‰
    font_size = max(10, int(width * (full_settings['size_percent'] / 100)))
    font_path = get_default_font_path()
    try:
        font = ImageFont.truetype(font_path, font_size) if font_path else ImageFont.load_default()
    except:
        font = ImageFont.load_default()

    # æ°´å°åŸºç¡€å‚æ•°ï¼ˆä½¿ç”¨è¡¥å…¨åçš„full_settingsï¼‰
    text = full_settings['text']
    opacity = int(full_settings['opacity'] * 255 / 100)
    hex_color = full_settings['color'].lstrip('#')
    try:
        rgb = tuple(int(hex_color[i:i + 2], 16) for i in (0, 2, 4))
    except:
        rgb = (255, 0, 0)  # é»˜è®¤çº¢è‰²
    fill_color = rgb + (opacity,)

    # è®¡ç®—æ–‡å­—å°ºå¯¸ä¸ä¸­å¿ƒç‚¹
    try:
        bbox = draw.textbbox((0, 0), text, font=font)
        text_w, text_h = bbox[2] - bbox[0], bbox[3] - bbox[1]
    except:
        text_w, text_h = draw.textsize(text, font=font)
    text_center_x, text_center_y = text_w / 2, text_h / 2

    # åç§»é‡ï¼ˆç™¾åˆ†æ¯”è½¬åƒç´ ï¼‰
    fill_mode = full_settings['fill_mode']
    offset_x_px = full_settings['offset_x'] / 100 * width
    offset_y_px = full_settings['offset_y'] / 100 * height

    # æ–‡å­—åŸºå‡†ä½ç½®ï¼ˆå›¾ç‰‡ä¸­å¿ƒ+åç§»ï¼‰
    base_x = (width / 2 - text_center_x) + offset_x_px
    base_y = (height / 2 - text_center_y) + offset_y_px

    # ç»˜åˆ¶æ°´å°ï¼ˆå•ä¸ª/å¹³é“ºï¼‰
    if fill_mode == 'single':
        draw.text((base_x, base_y), text, font=font, fill=fill_color)
    elif fill_mode == 'tiled':
        spacing_x, spacing_y = int(text_w * 1.5), int(text_h * 2.5)
        start_x = base_x - (base_x // spacing_x) * spacing_x
        start_y = base_y - (base_y // spacing_y) * spacing_y
        for i in range(-1, int(width / spacing_x) + 2):
            for j in range(-1, int(height / spacing_y) + 2):
                draw.text((start_x + i * spacing_x, start_y + j * spacing_y), text, font=font, fill=fill_color)

    # æ—‹è½¬ï¼ˆä»¥æ–‡å­—ä¸­å¿ƒä¸ºè½´å¿ƒï¼‰
    angle = full_settings['angle']
    if angle != 0:
        canvas_text_center = (base_x + text_center_x, base_y + text_center_y)
        txt_layer = txt_layer.rotate(
            angle,
            center=canvas_text_center,
            expand=False,
            resample=Image.Resampling.BICUBIC
        )

    # åˆå¹¶å›¾å±‚å¹¶æ¢å¤åŸæ ¼å¼ï¼ˆå»é™¤Alphaé€šé“ï¼‰
    out = Image.alpha_composite(base_image, txt_layer)
    if pil_image.mode != 'RGBA':
        out = out.convert(pil_image.mode)
    return out


# --- å¯æ‹–æ‹½é¢„è§ˆæ ‡ç­¾ ---
class DraggablePreviewLabel(QLabel):
    offsetChanged = pyqtSignal(int, int)

    def __init__(self, parent=None):
        super().__init__(parent)
        self.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.setStyleSheet("background-color: #333; border: 1px solid #555;")
        self._pixmap_original = None
        self._current_settings = {}
        self._start_pos = None
        self._current_offset_x = 0
        self._current_offset_y = 0
        self.setCursor(Qt.CursorShape.OpenHandCursor)

    def set_image(self, pil_image):
        """è®¾ç½®åŸå§‹å›¾ç‰‡"""
        self._pixmap_original = pil_image.copy()
        self.update_watermark_display()

    def set_settings(self, settings):
        """è®¾ç½®æ°´å°å‚æ•°å¹¶æ›´æ–°é¢„è§ˆï¼ˆè¡¥å…¨ç¼ºå¤±å­—æ®µï¼‰"""
        # è¡¥å…¨settingsï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µå­˜åœ¨
        full_settings = DEFAULT_CONFIG.copy()
        full_settings.update(settings)
        self._current_settings = full_settings
        self._current_offset_x = full_settings['offset_x']
        self._current_offset_y = full_settings['offset_y']
        self.update_watermark_display()

    def update_watermark_display(self):
        """ç”Ÿæˆå¸¦æ°´å°çš„é¢„è§ˆå›¾"""
        if self._pixmap_original is None:
            # ç©ºé¢„è§ˆèƒŒæ™¯
            pix = QPixmap(self.size())
            pix.fill(QColor("#333333"))
            painter = QPainter(pix)
            painter.setPen(QColor("#AAAAAA"))
            painter.setFont(QFont("Arial", 16))
            painter.drawText(self.rect(), Qt.AlignmentFlag.AlignCenter, "ç­‰å¾…æ‹–å…¥å›¾ç‰‡/Wordæ–‡æ¡£...")
            painter.end()
            self.setPixmap(pix)
            return

        # åº”ç”¨è¡¥å…¨åçš„è®¾ç½®ç”Ÿæˆæ°´å°
        watermarked_pil = apply_watermark_to_image(self._pixmap_original, self._current_settings)
        try:
            im_data = watermarked_pil.convert("RGBA").tobytes("raw", "RGBA")
            qim = QImage(im_data, watermarked_pil.width, watermarked_pil.height, QImage.Format.Format_RGBA8888)
            pix = QPixmap.fromImage(qim).scaled(
                self.size(),
                Qt.AspectRatioMode.KeepAspectRatio,
                Qt.TransformationMode.SmoothTransformation
            )
            self.setPixmap(pix)
        except Exception as e:
            print(f"é¢„è§ˆæ¸²æŸ“é”™è¯¯: {e}")

    def resizeEvent(self, event):
        """å°ºå¯¸å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“"""
        super().resizeEvent(event)
        self.update_watermark_display()

    def mousePressEvent(self, event):
        """é¼ æ ‡æŒ‰ä¸‹ï¼šè®°å½•èµ·å§‹ä½ç½®"""
        if event.button() == Qt.MouseButton.LeftButton and self._pixmap_original:
            self._start_pos = event.pos()
            self.setCursor(Qt.CursorShape.ClosedHandCursor)

    def mouseMoveEvent(self, event):
        """é¼ æ ‡æ‹–åŠ¨ï¼šæ›´æ–°åç§»é‡"""
        if self._start_pos and event.buttons() & Qt.MouseButton.LeftButton and self._pixmap_original:
            # è®¡ç®—ç§»åŠ¨é‡ï¼ˆé¢„è§ˆâ†’åŸå›¾æ¯”ä¾‹è½¬æ¢ï¼‰
            delta_screen = event.pos() - self._start_pos
            original_w, original_h = self._pixmap_original.width, self._pixmap_original.height
            scaled_size = self.pixmap().size() if self.pixmap() else QSize(1, 1)
            scale_x = original_w / scaled_size.width() if scaled_size.width() > 0 else 1.0
            scale_y = original_h / scaled_size.height() if scaled_size.height() > 0 else 1.0

            # è½¬æ¢ä¸ºç™¾åˆ†æ¯”åç§»ï¼ˆé™åˆ¶èŒƒå›´ï¼š-200~200%ï¼‰
            delta_x_percent = (delta_screen.x() * scale_x / original_w) * 100
            delta_y_percent = (delta_screen.y() * scale_y / original_h) * 100
            self._current_offset_x = max(-200, min(200, self._current_offset_x + delta_x_percent))
            self._current_offset_y = max(-200, min(200, self._current_offset_y + delta_y_percent))

            # åŒæ­¥æ›´æ–°UIï¼ˆè¡¥å…¨è®¾ç½®ï¼‰
            self._start_pos = event.pos()
            self.offsetChanged.emit(int(self._current_offset_x), int(self._current_offset_y))
            # æ›´æ–°å½“å‰è®¾ç½®ä¸­çš„åç§»é‡
            self._current_settings['offset_x'] = self._current_offset_x
            self._current_settings['offset_y'] = self._current_offset_y
            self.update_watermark_display()
        super().mouseMoveEvent(event)

    def mouseReleaseEvent(self, event):
        """é¼ æ ‡é‡Šæ”¾ï¼šé‡ç½®çŠ¶æ€"""
        self._start_pos = None
        self.setCursor(Qt.CursorShape.OpenHandCursor)


# --- å•ç‹¬ç¼–è¾‘å¯¹è¯æ¡† ---
class EditDialog(QDialog):
    def __init__(self, image_data, current_settings, parent=None):
        super().__init__(parent)
        self.setWindowTitle("å•ç‹¬å¾®è°ƒå›¾ç‰‡")
        self.resize(900, 600)
        self.original_pil = Image.open(io.BytesIO(image_data)) if isinstance(image_data, bytes) else image_data
        self.pil_format, self.file_ext = get_image_format(self.original_pil)
        # è¡¥å…¨settingsï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µå­˜åœ¨ï¼ˆé¿å…ç¼ºå¤±'text'ç­‰ï¼‰
        self.settings = DEFAULT_CONFIG.copy()
        self.settings.update(current_settings)
        self.init_ui()

    def init_ui(self):
        """åˆå§‹åŒ–å¯¹è¯æ¡†UIï¼ˆä½¿ç”¨è¡¥å…¨åçš„settingsï¼‰"""
        main_layout = QHBoxLayout(self)

        # é¢„è§ˆåŒºåŸŸ
        self.preview_label = QLabel()
        self.preview_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.preview_label.setStyleSheet("background-color: #333;")
        main_layout.addWidget(self.preview_label, stretch=2)

        # æ§åˆ¶åŒºåŸŸ
        ctrl_widget = QWidget()
        form_layout = QFormLayout(ctrl_widget)

        # æ°´å°æ–‡å­—ï¼ˆä½¿ç”¨è¡¥å…¨åçš„settingsï¼Œé¿å…KeyErrorï¼‰
        self.inp_text = QLineEdit(self.settings['text'])
        self.inp_text.textChanged.connect(self.update_preview)
        form_layout.addRow("æ–‡å­—:", self.inp_text)

        # å­—ä½“å¤§å°ï¼ˆ1-50%ï¼‰
        self.sl_size = QSlider(Qt.Orientation.Horizontal)
        self.sl_size.setRange(1, 50)
        self.sl_size.setValue(self.settings['size_percent'])
        self.sl_size.valueChanged.connect(self.update_preview)
        form_layout.addRow("å­—ä½“å¤§å° (%):", self.sl_size)

        # é€æ˜åº¦ï¼ˆ0-100%ï¼‰
        self.sl_opacity = QSlider(Qt.Orientation.Horizontal)
        self.sl_opacity.setRange(0, 100)
        self.sl_opacity.setValue(self.settings['opacity'])
        self.sl_opacity.valueChanged.connect(self.update_preview)
        form_layout.addRow("é€æ˜åº¦ (%):", self.sl_opacity)

        # æ—‹è½¬è§’åº¦ï¼ˆ0-360Â°ï¼‰
        self.sl_angle = QSlider(Qt.Orientation.Horizontal)
        self.sl_angle.setRange(0, 360)
        self.sl_angle.setValue(self.settings['angle'])
        self.sl_angle.valueChanged.connect(self.update_preview)
        form_layout.addRow("æ—‹è½¬è§’åº¦:", self.sl_angle)

        # X/Yè½´åç§»ï¼ˆ-200~200%ï¼‰
        self.sl_offset_x = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_x.setRange(-200, 200)
        self.sl_offset_x.setValue(self.settings['offset_x'])
        self.sl_offset_x.valueChanged.connect(self.update_preview)
        form_layout.addRow("Xè½´åç§» (%):", self.sl_offset_x)

        self.sl_offset_y = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_y.setRange(-200, 200)
        self.sl_offset_y.setValue(self.settings['offset_y'])
        self.sl_offset_y.valueChanged.connect(self.update_preview)
        form_layout.addRow("Yè½´åç§» (%):", self.sl_offset_y)

        # å¡«å……æ¨¡å¼
        self.cmb_fill_mode = QComboBox()
        self.cmb_fill_mode.addItem("å•ä¸ª (å±…ä¸­)", "single")
        self.cmb_fill_mode.addItem("å¹³é“º (é‡å¤)", "tiled")
        idx = self.cmb_fill_mode.findData(self.settings['fill_mode'])
        if idx != -1:
            self.cmb_fill_mode.setCurrentIndex(idx)
        self.cmb_fill_mode.currentIndexChanged.connect(self.update_preview)
        form_layout.addRow("å¡«å……æ¨¡å¼:", self.cmb_fill_mode)

        # ç¡®è®¤/å–æ¶ˆæŒ‰é’®
        btn_box = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel)
        btn_box.accepted.connect(self.accept)
        btn_box.rejected.connect(self.reject)
        form_layout.addRow(btn_box)

        main_layout.addWidget(ctrl_widget, stretch=1)
        self.update_preview()

    def update_preview(self):
        """æ›´æ–°é¢„è§ˆå›¾ï¼ˆä½¿ç”¨è¡¥å…¨åçš„settingsï¼‰"""
        self.settings.update({
            'text': self.inp_text.text(),
            'size_percent': self.sl_size.value(),
            'opacity': self.sl_opacity.value(),
            'angle': self.sl_angle.value(),
            'offset_x': self.sl_offset_x.value(),
            'offset_y': self.sl_offset_y.value(),
            'fill_mode': self.cmb_fill_mode.currentData()
        })
        watermarked_pil = apply_watermark_to_image(self.original_pil, self.settings)
        try:
            im_data = watermarked_pil.convert("RGBA").tobytes("raw", "RGBA")
            qim = QImage(im_data, watermarked_pil.width, watermarked_pil.height, QImage.Format.Format_RGBA8888)
            pix = QPixmap.fromImage(qim).scaled(
                self.preview_label.size(),
                Qt.AspectRatioMode.KeepAspectRatio,
                Qt.TransformationMode.SmoothTransformation
            )
            self.preview_label.setPixmap(pix)
        except Exception as e:
            self.parent().log(f"é¢„è§ˆæ›´æ–°é”™è¯¯: {str(e)}")

    def get_settings(self):
        """è¿”å›ç¼–è¾‘åçš„è®¾ç½®ï¼ˆä¿ç•™skip_watermarkæ ‡è®°ï¼‰"""
        return self.settings


# --- æ‰¹é‡ç¼–è¾‘å¯¹è¯æ¡† ---
class BatchEditDialog(QDialog):
    def __init__(self, preview_image, current_settings, parent=None):
        super().__init__(parent)
        self.setWindowTitle("æ‰¹é‡ä¿®æ”¹æ°´å°")
        self.resize(900, 600)
        self.original_pil = preview_image
        self.pil_format, self.file_ext = get_image_format(self.original_pil)
        # è¡¥å…¨settingsï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µå­˜åœ¨
        self.settings = DEFAULT_CONFIG.copy()
        self.settings.update(current_settings)
        self.init_ui()

    def init_ui(self):
        """åˆå§‹åŒ–UIï¼ˆä¸å•ç‹¬ç¼–è¾‘ä¸€è‡´ï¼Œå¤ç”¨é€»è¾‘ï¼‰"""
        main_layout = QHBoxLayout(self)

        # é¢„è§ˆåŒºåŸŸ
        self.preview_label = QLabel()
        self.preview_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.preview_label.setStyleSheet("background-color: #333;")
        main_layout.addWidget(self.preview_label, stretch=2)

        # æ§åˆ¶åŒºåŸŸ
        ctrl_widget = QWidget()
        form_layout = QFormLayout(ctrl_widget)

        # æ°´å°æ–‡å­—ï¼ˆè¡¥å…¨åæ— KeyErrorï¼‰
        self.inp_text = QLineEdit(self.settings['text'])
        self.inp_text.textChanged.connect(self.update_preview)
        form_layout.addRow("æ–‡å­—:", self.inp_text)

        # å­—ä½“å¤§å°
        self.sl_size = QSlider(Qt.Orientation.Horizontal)
        self.sl_size.setRange(1, 50)
        self.sl_size.setValue(self.settings['size_percent'])
        self.sl_size.valueChanged.connect(self.update_preview)
        form_layout.addRow("å­—ä½“å¤§å° (%):", self.sl_size)

        # é€æ˜åº¦
        self.sl_opacity = QSlider(Qt.Orientation.Horizontal)
        self.sl_opacity.setRange(0, 100)
        self.sl_opacity.setValue(self.settings['opacity'])
        self.sl_opacity.valueChanged.connect(self.update_preview)
        form_layout.addRow("é€æ˜åº¦ (%):", self.sl_opacity)

        # æ—‹è½¬è§’åº¦
        self.sl_angle = QSlider(Qt.Orientation.Horizontal)
        self.sl_angle.setRange(0, 360)
        self.sl_angle.setValue(self.settings['angle'])
        self.sl_angle.valueChanged.connect(self.update_preview)
        form_layout.addRow("æ—‹è½¬è§’åº¦:", self.sl_angle)

        # X/Yè½´åç§»
        self.sl_offset_x = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_x.setRange(-200, 200)
        self.sl_offset_x.setValue(self.settings['offset_x'])
        self.sl_offset_x.valueChanged.connect(self.update_preview)
        form_layout.addRow("Xè½´åç§» (%):", self.sl_offset_x)

        self.sl_offset_y = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_y.setRange(-200, 200)
        self.sl_offset_y.setValue(self.settings['offset_y'])
        self.sl_offset_y.valueChanged.connect(self.update_preview)
        form_layout.addRow("Yè½´åç§» (%):", self.sl_offset_y)

        # å¡«å……æ¨¡å¼
        self.cmb_fill_mode = QComboBox()
        self.cmb_fill_mode.addItem("å•ä¸ª (å±…ä¸­)", "single")
        self.cmb_fill_mode.addItem("å¹³é“º (é‡å¤)", "tiled")
        idx = self.cmb_fill_mode.findData(self.settings['fill_mode'])
        if idx != -1:
            self.cmb_fill_mode.setCurrentIndex(idx)
        self.cmb_fill_mode.currentIndexChanged.connect(self.update_preview)
        form_layout.addRow("å¡«å……æ¨¡å¼:", self.cmb_fill_mode)

        # æŒ‰é’®
        btn_box = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel)
        btn_box.accepted.connect(self.accept)
        btn_box.rejected.connect(self.reject)
        form_layout.addRow(btn_box)

        main_layout.addWidget(ctrl_widget, stretch=1)
        self.update_preview()

    def update_preview(self):
        """æ›´æ–°é¢„è§ˆï¼ˆä½¿ç”¨è¡¥å…¨åçš„settingsï¼‰"""
        self.settings.update({
            'text': self.inp_text.text(),
            'size_percent': self.sl_size.value(),
            'opacity': self.sl_opacity.value(),
            'angle': self.sl_angle.value(),
            'offset_x': self.sl_offset_x.value(),
            'offset_y': self.sl_offset_y.value(),
            'fill_mode': self.cmb_fill_mode.currentData()
        })
        watermarked_pil = apply_watermark_to_image(self.original_pil, self.settings)
        try:
            im_data = watermarked_pil.convert("RGBA").tobytes("raw", "RGBA")
            qim = QImage(im_data, watermarked_pil.width, watermarked_pil.height, QImage.Format.Format_RGBA8888)
            pix = QPixmap.fromImage(qim).scaled(
                self.preview_label.size(),
                Qt.AspectRatioMode.KeepAspectRatio,
                Qt.TransformationMode.SmoothTransformation
            )
            self.preview_label.setPixmap(pix)
        except Exception as e:
            self.parent().log(f"é¢„è§ˆæ›´æ–°é”™è¯¯: {str(e)}")

    def get_settings(self):
        """è¿”å›æ‰¹é‡ç¼–è¾‘åçš„è®¾ç½®"""
        return self.settings


# --- å›¾ç‰‡å¤„ç†çº¿ç¨‹ï¼ˆé¿å…UIé˜»å¡ï¼‰---
class ImageProcessThread(QThread):
    progress_update = pyqtSignal(int)
    finished_signal = pyqtSignal(list)
    error_signal = pyqtSignal(str)

    def __init__(self, image_paths, global_settings):
        super().__init__()
        # è¡¥å…¨å…¨å±€è®¾ç½®ï¼Œç¡®ä¿çº¿ç¨‹å¤„ç†æ—¶æ— ç¼ºå¤±å­—æ®µ
        self.global_settings = DEFAULT_CONFIG.copy()
        self.global_settings.update(global_settings)
        self.image_paths = image_paths

    def run(self):
        """çº¿ç¨‹æ‰§è¡Œï¼šæ‰¹é‡å¤„ç†å›¾ç‰‡"""
        processed_images = []
        total = len(self.image_paths)
        for i, path in enumerate(self.image_paths):
            try:
                # è¯»å–åŸå›¾
                with open(path, 'rb') as f:
                    original_data = f.read()

                # å¤„ç†æ°´å°ï¼ˆä½¿ç”¨è¡¥å…¨åçš„å…¨å±€è®¾ç½®ï¼‰
                with Image.open(io.BytesIO(original_data)) as pil_img:
                    pil_format, file_ext = get_image_format(pil_img)
                    watermarked_img = apply_watermark_to_image(pil_img, self.global_settings)

                    # ä¿å­˜ä¸ºåŸæ ¼å¼ï¼ˆJPEGéœ€å»é™¤Alphaï¼‰
                    out_io = io.BytesIO()
                    if pil_format == 'JPEG' and watermarked_img.mode == 'RGBA':
                        watermarked_img = watermarked_img.convert('RGB')
                    watermarked_img.save(out_io, format=pil_format, quality=90)
                    processed_data = out_io.getvalue()

                # è®°å½•ç»“æœï¼ˆä¿å­˜è¡¥å…¨åçš„è®¾ç½®ï¼‰
                processed_images.append({
                    "original_path": path,
                    "original_data": original_data,
                    "processed_data": processed_data,
                    "pil_format": pil_format,
                    "file_ext": file_ext,
                    "settings": self.global_settings.copy()
                })
                self.progress_update.emit(int((i + 1) / total * 100))
            except Exception as e:
                self.error_signal.emit(f"å¤„ç† {os.path.basename(path)} å¤±è´¥: {str(e)}")
        self.finished_signal.emit(processed_images)


# --- ä¸»çª—å£ï¼ˆæ ¸å¿ƒUIä¸é€»è¾‘ï¼‰---
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("å›¾ç‰‡/Wordæ‰¹é‡æ°´å°å·¥å…· v5.6 (å®Œæ•´æ— ä¸­æ–­ç‰ˆ)")
        self.resize(1200, 800)
        self.setAcceptDrops(True)
        self.config = load_config()
        self.doc = None  # Wordæ–‡æ¡£å¯¹è±¡
        self.doc_path = None  # Wordè·¯å¾„
        self.image_parts = []  # Wordä¸­çš„å›¾ç‰‡
        self.direct_images = []  # ç›´æ¥æ‹–å…¥çš„å›¾ç‰‡
        self.process_thread = None  # å¤„ç†çº¿ç¨‹
        self.init_ui()
        self.load_sample_preview()
        self.update_live_preview()

    def load_sample_preview(self):
        """åŠ è½½é»˜è®¤é¢„è§ˆèƒŒæ™¯å›¾"""
        try:
            sample_img = Image.new("RGB", (800, 600), color='#f0f0f0')
            draw = ImageDraw.Draw(sample_img)
            text = "é¢„è§ˆèƒŒæ™¯å›¾\n(æ”¯æŒæ‹–å…¥Word/å›¾ç‰‡)\nå¯¼å‡ºè·¯å¾„ï¼šåŸæ–‡ä»¶å¤¹/å·²åŠ æ°´å°å›¾ç‰‡\né¢œè‰²é€‰é¡¹ï¼šä»…ç°/çº¢/è“"
            font_path = get_default_font_path()
            try:
                font = ImageFont.truetype(font_path, 24) if font_path else ImageFont.load_default()
            except:
                font = ImageFont.load_default()

            # è®¡ç®—æ–‡å­—ä½ç½®ï¼ˆå±…ä¸­ï¼‰
            try:
                bbox = draw.textbbox((0, 0), text, font=font)
                text_w, text_h = bbox[2] - bbox[0], bbox[3] - bbox[1]
            except:
                text_w, text_h = draw.textsize(text, font=font)
            draw.text(((800 - text_w) / 2, (600 - text_h) / 2), text, font=font, fill=(100, 100, 100))
            self.live_preview_label.set_image(sample_img)
        except Exception as e:
            self.log(f"åŠ è½½é¢„è§ˆèƒŒæ™¯å¤±è´¥: {str(e)}")

    def update_live_preview(self):
        """æ›´æ–°å·¦ä¾§å®æ—¶é¢„è§ˆï¼ˆä½¿ç”¨è¡¥å…¨åçš„è®¾ç½®ï¼‰"""
        current_settings = {
            "text": self.inp_text.text(),
            "size_percent": self.sl_size.value(),
            "opacity": self.sl_opacity.value(),
            "angle": self.sl_angle.value(),
            "color": self.config['color'],
            "fill_mode": self.cmb_fill_mode.currentData(),
            "offset_x": self.sl_offset_x.value(),
            "offset_y": self.sl_offset_y.value()
        }
        # è¡¥å…¨è®¾ç½®åå†ä¼ é€’
        full_settings = DEFAULT_CONFIG.copy()
        full_settings.update(current_settings)
        self.live_preview_label.set_settings(full_settings)

    def on_preview_offset_changed(self, offset_x, offset_y):
        """æ‹–æ‹½é¢„è§ˆæ—¶åŒæ­¥æ»‘å—å€¼"""
        # ä¸´æ—¶æ–­å¼€ä¿¡å·é¿å…å¾ªç¯æ›´æ–°
        self.sl_offset_x.valueChanged.disconnect(self.update_live_preview)
        self.sl_offset_y.valueChanged.disconnect(self.update_live_preview)
        self.sl_offset_x.setValue(offset_x)
        self.sl_offset_y.setValue(offset_y)
        # é‡æ–°è¿æ¥ä¿¡å·
        self.sl_offset_x.valueChanged.connect(self.update_live_preview)
        self.sl_offset_y.valueChanged.connect(self.update_live_preview)

    def set_color_ui(self, hex_color, update_config=True):
        """æ›´æ–°é¢œè‰²UIä¸é…ç½®"""
        if update_config:
            self.config['color'] = hex_color
        self.btn_color.setStyleSheet(f"text-align: left; color: {hex_color}; font-weight: bold;")
        self.update_live_preview()

    def show_color_menu(self):
        """æ˜¾ç¤ºé¢œè‰²èœå•ï¼ˆä»…ç°/çº¢/è“ï¼‰"""
        menu = QMenu(self)
        # ä»…ä¿ç•™ä¸‰ä¸ªæ ¸å¿ƒé¢œè‰²
        colors = {
            "ç°è‰²": "#808080",
            "çº¢è‰²": "#FF0000",
            "è“è‰²": "#0000FF"
        }
        for name, hex_code in colors.items():
            action = QAction(f"{name} ({hex_code})", self)
            # é¢œè‰²å›¾æ ‡
            pixmap = QPixmap(16, 16)
            pixmap.fill(QColor(hex_code))
            action.setIcon(QIcon(pixmap))
            # ç»‘å®šé¢œè‰²é€‰æ‹©äº‹ä»¶
            action.triggered.connect(lambda checked, h=hex_code: self.set_color_ui(h))
            menu.addAction(action)
        # æ˜¾ç¤ºèœå•ï¼ˆåœ¨æŒ‰é’®ä¸‹æ–¹ï¼‰
        menu.exec(self.btn_color.mapToGlobal(QPoint(0, self.btn_color.height())))

    def log(self, msg):
        """æ·»åŠ è¿è¡Œæ—¥å¿—"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        self.log_box.appendPlainText(f"[{timestamp}] {msg}")
        self.log_box.verticalScrollBar().setValue(self.log_box.verticalScrollBar().maximum())
        QApplication.processEvents()

    def init_ui(self):
        """åˆå§‹åŒ–ä¸»çª—å£UI"""
        QApplication.setStyle("Fusion")
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        main_h_layout = QHBoxLayout(central_widget)

        # ---------------------- å·¦ä¾§é¢æ¿ï¼ˆå‚æ•°+é¢„è§ˆï¼‰----------------------
        left_panel = QWidget()
        left_v_layout = QVBoxLayout(left_panel)

        # 1. å¤„ç†æ¨¡å¼é€‰æ‹©ï¼ˆWord/å›¾ç‰‡ï¼‰
        mode_group = QGroupBox("å¤„ç†æ¨¡å¼")
        mode_layout = QHBoxLayout(mode_group)
        self.radio_word = QRadioButton("Wordæ–‡æ¡£å¤„ç†")
        self.radio_image = QRadioButton("å›¾ç‰‡æ–‡ä»¶å¤„ç†")
        self.radio_word.setChecked(True)  # é»˜è®¤Wordæ¨¡å¼
        mode_layout.addWidget(self.radio_word)
        mode_layout.addWidget(self.radio_image)
        left_v_layout.addWidget(mode_group)

        # 2. å®æ—¶é¢„è§ˆåŒºåŸŸ
        preview_frame = QFrame()
        preview_frame.setFrameShape(QFrame.Shape.Box)
        preview_frame.setFrameShadow(QFrame.Shadow.Raised)
        preview_layout = QVBoxLayout(preview_frame)
        preview_layout.addWidget(QLabel("<b>å®æ—¶é¢„è§ˆï¼ˆæ‹–æ‹½è°ƒæ•´ä½ç½®ï¼‰:</b>"))
        self.live_preview_label = DraggablePreviewLabel()
        self.live_preview_label.setMinimumSize(280, 180)
        self.live_preview_label.offsetChanged.connect(self.on_preview_offset_changed)
        preview_layout.addWidget(self.live_preview_label)
        left_v_layout.addWidget(preview_frame)

        # 3. å¯¼å‡ºè¯´æ˜
        export_note = QLabel(
            "<font color='green'>ğŸ“Œ å›¾ç‰‡å¯¼å‡ºè¯´æ˜ï¼š</font><br/>è‡ªåŠ¨ä¿å­˜åˆ°åŸæ–‡ä»¶å¤¹çš„<br/><b>ã€Œå·²åŠ æ°´å°å›¾ç‰‡ã€</b> å­æ–‡ä»¶å¤¹<br/>ä¿ç•™åŸæ ¼å¼ï¼ˆJPEGâ†’JPGï¼‰"
        )
        export_note.setStyleSheet("margin: 10px 0;")
        left_v_layout.addWidget(export_note)

        # 4. å…¨å±€å‚æ•°è®¾ç½®
        settings_title = QLabel("âš™ï¸ å…¨å±€å‚æ•°è®¾ç½®")
        settings_title.setStyleSheet("font-weight: bold; font-size: 14pt;")
        left_v_layout.addWidget(settings_title)

        form_layout = QFormLayout()

        # æ°´å°æ–‡å­—ï¼ˆåˆå§‹å€¼ä»é…ç½®è¯»å–ï¼Œç¡®ä¿å­˜åœ¨ï¼‰
        self.inp_text = QLineEdit(self.config['text'])
        self.inp_text.textChanged.connect(self.update_live_preview)
        form_layout.addRow("æ°´å°æ–‡å­—:", self.inp_text)

        # å­—ä½“å¤§å°
        self.sl_size = QSlider(Qt.Orientation.Horizontal)
        self.sl_size.setRange(1, 50)
        self.sl_size.setValue(self.config['size_percent'])
        self.sl_size.setToolTip("æ–‡å­—å®½åº¦å å›¾ç‰‡å®½åº¦çš„ç™¾åˆ†æ¯”")
        self.sl_size.valueChanged.connect(self.update_live_preview)
        form_layout.addRow("å­—ä½“å¤§å° (1-50%):", self.sl_size)

        # é€æ˜åº¦
        self.sl_opacity = QSlider(Qt.Orientation.Horizontal)
        self.sl_opacity.setRange(0, 100)
        self.sl_opacity.setValue(self.config['opacity'])
        self.sl_opacity.valueChanged.connect(self.update_live_preview)
        form_layout.addRow("é€æ˜åº¦ (0-100%):", self.sl_opacity)

        # æ—‹è½¬è§’åº¦
        self.sl_angle = QSlider(Qt.Orientation.Horizontal)
        self.sl_angle.setRange(0, 360)
        self.sl_angle.setValue(self.config['angle'])
        self.sl_angle.valueChanged.connect(self.update_live_preview)
        form_layout.addRow("æ—‹è½¬è§’åº¦:", self.sl_angle)

        # å¡«å……æ¨¡å¼
        self.cmb_fill_mode = QComboBox()
        self.cmb_fill_mode.addItem("å•ä¸ª (å±…ä¸­)", "single")
        self.cmb_fill_mode.addItem("å¹³é“º (é‡å¤)", "tiled")
        idx = self.cmb_fill_mode.findData(self.config['fill_mode'])
        if idx != -1:
            self.cmb_fill_mode.setCurrentIndex(idx)
        self.cmb_fill_mode.currentTextChanged.connect(self.update_live_preview)
        form_layout.addRow("å¡«å……æ¨¡å¼:", self.cmb_fill_mode)

        # X/Yè½´åç§»
        self.sl_offset_x = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_x.setRange(-200, 200)
        self.sl_offset_x.setValue(self.config['offset_x'])
        self.sl_offset_x.valueChanged.connect(self.update_live_preview)
        form_layout.addRow("Xè½´åç§» (%):", self.sl_offset_x)

        self.sl_offset_y = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_y.setRange(-200, 200)
        self.sl_offset_y.setValue(self.config['offset_y'])
        self.sl_offset_y.valueChanged.connect(self.update_live_preview)
        form_layout.addRow("Yè½´åç§» (%):", self.sl_offset_y)

        # é¢œè‰²é€‰æ‹©ï¼ˆä»…ç°/çº¢/è“ï¼‰
        self.btn_color = QPushButton("é€‰æ‹©é¢œè‰² â–  (ä»…ç°/çº¢/è“)")
        self.set_color_ui(self.config['color'], update_config=False)
        self.btn_color.clicked.connect(self.show_color_menu)
        form_layout.addRow("æ–‡å­—é¢œè‰²:", self.btn_color)

        left_v_layout.addLayout(form_layout)
        left_v_layout.addSpacing(20)

        # 5. æ“ä½œæŒ‰é’®
        self.btn_apply = QPushButton("â–¶ åº”ç”¨æ°´å°åˆ°æ‰€æœ‰æ–‡ä»¶")
        self.btn_apply.setMinimumHeight(40)
        self.btn_apply.clicked.connect(self.run_batch_process)
        self.btn_apply.setEnabled(False)
        left_v_layout.addWidget(self.btn_apply)

        self.btn_export = QPushButton("ğŸ’¾ å¯¼å‡ºæ–‡ä»¶")
        self.btn_export.setMinimumHeight(40)
        self.btn_export.clicked.connect(self.export_files)
        self.btn_export.setEnabled(False)
        left_v_layout.addWidget(self.btn_export)

        left_v_layout.addStretch()

        # 6. æ—¥å¿—åŒºåŸŸ
        left_v_layout.addWidget(QLabel("è¿è¡Œæ—¥å¿—:"))
        self.log_box = QPlainTextEdit()
        self.log_box.setReadOnly(True)
        self.log_box.setMaximumHeight(150)
        left_v_layout.addWidget(self.log_box)

        main_h_layout.addWidget(left_panel, stretch=1)

        # ---------------------- å³ä¾§é¢æ¿ï¼ˆæ–‡ä»¶åˆ—è¡¨ï¼‰----------------------
        right_panel = QWidget()
        right_v_layout = QVBoxLayout(right_panel)

        # 1. æ‹–å…¥æç¤º
        self.lbl_status = QLabel(
            "ğŸ“‚ è¯·å°† Wordæ–‡æ¡£ (.docx) æˆ–å›¾ç‰‡æ–‡ä»¶\n(PNG/JPG/BMPç­‰) æ‹–å…¥æ­¤å¤„\n\nå¯¼å‡ºè·¯å¾„ï¼šåŸæ–‡ä»¶å¤¹/å·²åŠ æ°´å°å›¾ç‰‡\nä¿ç•™åŸæ ¼å¼ï¼ˆJPEGâ†’JPGï¼‰\né¢œè‰²é€‰é¡¹ï¼šä»…ç°è‰²ã€çº¢è‰²ã€è“è‰²"
        )
        self.lbl_status.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.lbl_status.setStyleSheet("border: 2px dashed #aaa; font-size: 16px; color: #555; padding: 40px;")
        right_v_layout.addWidget(self.lbl_status)

        # 2. æ–‡ä»¶åˆ—è¡¨ï¼ˆå›¾æ ‡æ¨¡å¼ï¼‰
        self.list_widget = QListWidget()
        self.list_widget.setViewMode(QListWidget.ViewMode.IconMode)
        self.list_widget.setIconSize(QSize(150, 150))
        self.list_widget.setSpacing(10)
        self.list_widget.setMovement(QListWidget.Movement.Static)
        self.list_widget.setVisible(False)
        # æ”¯æŒå¤šé€‰å’Œå³é”®èœå•
        self.list_widget.setSelectionMode(QListWidget.SelectionMode.ExtendedSelection)
        self.list_widget.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        self.list_widget.customContextMenuRequested.connect(self.on_list_context_menu)
        self.list_widget.itemDoubleClicked.connect(self.on_item_double_click)
        right_v_layout.addWidget(self.list_widget)

        # 3. è¿›åº¦æ¡
        self.progress = QProgressBar()
        self.progress.setVisible(False)
        right_v_layout.addWidget(self.progress)

        main_h_layout.addWidget(right_panel, stretch=2)

    def on_list_context_menu(self, position):
        """æ–‡ä»¶åˆ—è¡¨å³é”®èœå•"""
        selected_items = self.list_widget.selectedItems()
        if not selected_items:
            return
        menu = QMenu()
        # æ‰¹é‡ä¿®æ”¹æ°´å°
        modify_action = QAction("ä¿®æ”¹æ°´å°", self)
        modify_action.triggered.connect(self.batch_modify_watermark)
        menu.addAction(modify_action)
        # æ‰¹é‡ä¸åŠ æ°´å°
        no_watermark_action = QAction("ä¸åŠ æ°´å°", self)
        no_watermark_action.triggered.connect(self.batch_remove_watermark)
        menu.addAction(no_watermark_action)
        # æ˜¾ç¤ºèœå•
        menu.exec(self.list_widget.mapToGlobal(position))

    def on_item_double_click(self, item):
        """åŒå‡»æ–‡ä»¶è¿›è¡Œå•ç‹¬ç¼–è¾‘ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šè¡¥å…¨settingså­—æ®µï¼‰"""
        item_data = item.data(Qt.ItemDataRole.UserRole)
        if not item_data:
            self.log("âŒ ç¼–è¾‘å¤±è´¥ï¼šæ— å›¾ç‰‡æ•°æ®")
            return
        item_type, idx = item_data
        try:
            if item_type == 'word':
                # ç¼–è¾‘Wordä¸­çš„å›¾ç‰‡
                word_item = self.image_parts[idx]
                # 1. è¡¥å…¨settingsï¼šä»¥é»˜è®¤é…ç½®ä¸ºåŸºç¡€ï¼Œè¦†ç›–å›¾ç‰‡è‡ªèº«çš„settingsï¼ˆå³ä½¿ä»…å«skip_watermarkï¼‰
                base_settings = DEFAULT_CONFIG.copy()
                if word_item.get('settings'):
                    base_settings.update(word_item['settings'])
                # 2. æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆä¼ é€’è¡¥å…¨åçš„settingsï¼‰
                dlg = EditDialog(word_item['original'], base_settings, self)
                if dlg.exec():
                    new_settings = dlg.get_settings()
                    # é‡æ–°å¤„ç†å›¾ç‰‡
                    with io.BytesIO(word_item['original']) as bio:
                        pil_img = Image.open(bio)
                        pil_format, file_ext = get_image_format(pil_img)
                        res_pil = apply_watermark_to_image(pil_img, new_settings)
                        out_io = io.BytesIO()
                        if pil_format == 'JPEG' and res_pil.mode == 'RGBA':
                            res_pil = res_pil.convert('RGB')
                        res_pil.save(out_io, format=pil_format, quality=90)
                        # æ›´æ–°æ•°æ®ï¼ˆä¿å­˜è¡¥å…¨åçš„settingsï¼‰
                        word_item['processed'] = out_io.getvalue()
                        word_item['settings'] = new_settings
                        word_item['pil_format'] = pil_format
                        word_item['file_ext'] = file_ext
                    self.log(f"âœï¸ å•ç‹¬ä¿®æ”¹ Wordå›¾ç‰‡ {idx + 1} (.{file_ext})")
                    self.update_file_list()

            elif item_type == 'image':
                # ç¼–è¾‘ç›´æ¥æ‹–å…¥çš„å›¾ç‰‡
                img_item = self.direct_images[idx]
                # 1. è¡¥å…¨settingsï¼šé¿å…ç¼ºå¤±'text'ç­‰å­—æ®µ
                base_settings = DEFAULT_CONFIG.copy()
                if img_item.get('settings'):
                    base_settings.update(img_item['settings'])
                # 2. æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
                with Image.open(io.BytesIO(img_item['original_data'])) as pil_img:
                    dlg = EditDialog(pil_img, base_settings, self)
                    if dlg.exec():
                        new_settings = dlg.get_settings()
                        # é‡æ–°å¤„ç†å›¾ç‰‡
                        with Image.open(io.BytesIO(img_item['original_data'])) as pil_img:
                            pil_format, file_ext = get_image_format(pil_img)
                            res_pil = apply_watermark_to_image(pil_img, new_settings)
                            out_io = io.BytesIO()
                            if pil_format == 'JPEG' and res_pil.mode == 'RGBA':
                                res_pil = res_pil.convert('RGB')
                            res_pil.save(out_io, format=pil_format, quality=90)
                            # æ›´æ–°æ•°æ®
                            img_item['processed_data'] = out_io.getvalue()
                            img_item['settings'] = new_settings
                            img_item['pil_format'] = pil_format
                            img_item['file_ext'] = file_ext
                        self.log(f"âœï¸ å•ç‹¬ä¿®æ”¹å›¾ç‰‡: {os.path.basename(img_item['original_path'])} (.{file_ext})")
                        self.update_file_list()
        except Exception as e:
            self.log(f"âŒ å•ç‹¬ç¼–è¾‘å¤±è´¥: {str(e)}")  # è¾“å‡ºå®Œæ•´é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºæ’æŸ¥
            QMessageBox.warning(self, "ç¼–è¾‘å¤±è´¥", f"ä¿®æ”¹å‡ºé”™: {str(e)}")

    def batch_modify_watermark(self):
        """æ‰¹é‡ä¿®æ”¹é€‰ä¸­å›¾ç‰‡çš„æ°´å°ï¼ˆè¡¥å…¨settingsï¼‰"""
        selected_items = self.list_widget.selectedItems()
        if not selected_items:
            return
        # è·å–ç¬¬ä¸€ä¸ªé€‰ä¸­é¡¹ä½œä¸ºé¢„è§ˆ
        first_item_data = selected_items[0].data(Qt.ItemDataRole.UserRole)
        if not first_item_data:
            self.log("âš ï¸ æ‰¹é‡ä¿®æ”¹å¤±è´¥ï¼šæ— é¢„è§ˆå›¾ç‰‡æ•°æ®")
            return
        item_type, idx = first_item_data
        preview_image = None
        try:
            if item_type == 'word':
                preview_image = Image.open(io.BytesIO(self.image_parts[idx]['original']))
            else:
                preview_image = Image.open(io.BytesIO(self.direct_images[idx]['original_data']))
        except Exception as e:
            self.log(f"âš ï¸ åŠ è½½é¢„è§ˆå›¾å¤±è´¥: {str(e)}")
            return

        # 1. è¡¥å…¨å½“å‰å…¨å±€è®¾ç½®ï¼Œé¿å…ç¼ºå¤±å­—æ®µ
        current_settings = DEFAULT_CONFIG.copy()
        current_settings.update({
            "text": self.inp_text.text(),
            "size_percent": self.sl_size.value(),
            "opacity": self.sl_opacity.value(),
            "angle": self.sl_angle.value(),
            "color": self.config['color'],
            "fill_mode": self.cmb_fill_mode.currentData(),
            "offset_x": self.sl_offset_x.value(),
            "offset_y": self.sl_offset_y.value()
        })
        # 2. æ‰“å¼€æ‰¹é‡ç¼–è¾‘å¯¹è¯æ¡†
        dlg = BatchEditDialog(preview_image, current_settings, self)
        if dlg.exec():
            new_settings = dlg.get_settings()
            processed_count = 0
            # åº”ç”¨åˆ°æ‰€æœ‰é€‰ä¸­é¡¹
            for item in selected_items:
                item_data = item.data(Qt.ItemDataRole.UserRole)
                if not item_data:
                    continue
                item_type, idx = item_data
                try:
                    if item_type == 'word':
                        # å¤„ç†Wordå›¾ç‰‡
                        with io.BytesIO(self.image_parts[idx]['original']) as bio:
                            pil_img = Image.open(bio)
                            pil_format, file_ext = get_image_format(pil_img)
                            res_pil = apply_watermark_to_image(pil_img, new_settings)
                            out_io = io.BytesIO()
                            if pil_format == 'JPEG' and res_pil.mode == 'RGBA':
                                res_pil = res_pil.convert('RGB')
                            res_pil.save(out_io, format=pil_format, quality=90)
                            # æ›´æ–°æ•°æ®ï¼ˆä¿å­˜è¡¥å…¨åçš„settingsï¼‰
                            self.image_parts[idx]['processed'] = out_io.getvalue()
                            self.image_parts[idx]['settings'] = new_settings
                            self.image_parts[idx]['pil_format'] = pil_format
                            self.image_parts[idx]['file_ext'] = file_ext
                        self.log(f"âœï¸ æ‰¹é‡ä¿®æ”¹ Wordå›¾ç‰‡ {idx + 1} (.{file_ext})")
                    else:
                        # å¤„ç†ç›´æ¥æ‹–å…¥çš„å›¾ç‰‡
                        with Image.open(io.BytesIO(self.direct_images[idx]['original_data'])) as pil_img:
                            pil_format, file_ext = get_image_format(pil_img)
                            res_pil = apply_watermark_to_image(pil_img, new_settings)
                            out_io = io.BytesIO()
                            if pil_format == 'JPEG' and res_pil.mode == 'RGBA':
                                res_pil = res_pil.convert('RGB')
                            res_pil.save(out_io, format=pil_format, quality=90)
                            # æ›´æ–°æ•°æ®
                            self.direct_images[idx]['processed_data'] = out_io.getvalue()
                            self.direct_images[idx]['settings'] = new_settings
                            self.direct_images[idx]['pil_format'] = pil_format
                            self.direct_images[idx]['file_ext'] = file_ext
                        self.log(
                            f"âœï¸ æ‰¹é‡ä¿®æ”¹å›¾ç‰‡: {os.path.basename(self.direct_images[idx]['original_path'])} (.{file_ext})")
                    # ç§»é™¤"ä¸åŠ æ°´å°"æ ‡è®°
                    if " [ä¸åŠ æ°´å°]" in item.text():
                        item.setText(item.text().replace(" [ä¸åŠ æ°´å°]", ""))
                    processed_count += 1
                except Exception as e:
                    self.log(f"âš ï¸ å¤„ç†å¤±è´¥ {item.text()}: {str(e)}")
            self.log(f"âœ… æ‰¹é‡ä¿®æ”¹å®Œæˆï¼Œå…±å¤„ç† {processed_count} å¼ å›¾ç‰‡")
            self.update_file_list()

    def batch_remove_watermark(self):
        """æ‰¹é‡è®¾ç½®å›¾ç‰‡ä¸åŠ æ°´å°ï¼ˆä¿ç•™å…¶ä»–å­—æ®µï¼Œé¿å…åç»­ç¼–è¾‘å‡ºé”™ï¼‰"""
        selected_items = self.list_widget.selectedItems()
        if not selected_items:
            return
        for item in selected_items:
            item_data = item.data(Qt.ItemDataRole.UserRole)
            if not item_data:
                continue
            item_type, idx = item_data
            # å…³é”®ä¿®å¤ï¼šè®¾ç½®skip_watermarkæ—¶ï¼Œä¿ç•™å…¶ä»–å­—æ®µï¼ˆä»¥é»˜è®¤é…ç½®ä¸ºåŸºç¡€ï¼‰
            skip_settings = DEFAULT_CONFIG.copy()
            skip_settings['skip_watermark'] = True  # ä»…æ·»åŠ è·³è¿‡æ ‡è®°ï¼Œä¸åˆ é™¤å…¶ä»–å­—æ®µ
            if item_type == 'word':
                # ä¿ç•™åŸå›¾ç‰‡çš„å…¶ä»–è®¾ç½®ï¼ˆå¦‚æœ‰ï¼‰
                if self.image_parts[idx].get('settings'):
                    skip_settings.update(self.image_parts[idx]['settings'])
                self.image_parts[idx]['settings'] = skip_settings
                self.image_parts[idx]['processed'] = self.image_parts[idx]['original']
                # æ¢å¤åŸæ ¼å¼
                with io.BytesIO(self.image_parts[idx]['original']) as bio:
                    pil_img = Image.open(bio)
                    pil_format, file_ext = get_image_format(pil_img)
                    self.image_parts[idx]['pil_format'] = pil_format
                    self.image_parts[idx]['file_ext'] = file_ext
            else:
                # ä¿ç•™åŸå›¾ç‰‡çš„å…¶ä»–è®¾ç½®ï¼ˆå¦‚æœ‰ï¼‰
                if self.direct_images[idx].get('settings'):
                    skip_settings.update(self.direct_images[idx]['settings'])
                self.direct_images[idx]['settings'] = skip_settings
                self.direct_images[idx]['processed_data'] = self.direct_images[idx]['original_data']
                # æ¢å¤åŸæ ¼å¼
                pil_format, file_ext = get_image_format(self.direct_images[idx]['original_path'])
                self.direct_images[idx]['pil_format'] = pil_format
                self.direct_images[idx]['file_ext'] = file_ext
            # æ·»åŠ æ ‡è®°
            if " [ä¸åŠ æ°´å°]" not in item.text():
                item.setText(item.text() + " [ä¸åŠ æ°´å°]")
        self.log(f"âœ… æ‰¹é‡è®¾ç½® {len(selected_items)} å¼ å›¾ç‰‡ï¼šä¸åŠ æ°´å°")
        self.update_file_list()

    # ---------------------- æ‹–æ‹½ç›¸å…³äº‹ä»¶ ----------------------
    def dragEnterEvent(self, event):
        """æ‹–æ‹½è¿›å…¥ï¼šä»…æ¥å—æ–‡ä»¶"""
        if event.mimeData().hasUrls():
            event.accept()
        else:
            event.ignore()

    def dropEvent(self, event):
        """æ‹–æ‹½é‡Šæ”¾ï¼šå¤„ç†Word/å›¾ç‰‡"""
        urls = event.mimeData().urls()
        if not urls:
            return
        file_paths = [url.toLocalFile() for url in urls]
        word_files = [p for p in file_paths if p.endswith(".docx")]
        image_files = [p for p in file_paths if is_supported_image(p)]

        # å¤„ç†Wordï¼ˆä¸€æ¬¡ä¸€ä¸ªï¼‰
        if word_files:
            self.load_doc(word_files[0])
            if len(word_files) > 1:
                self.log(f"âš ï¸ ä¸€æ¬¡ä»…æ”¯æŒ1ä¸ªWordï¼Œå¿½ç•¥å…¶ä»– {len(word_files) - 1} ä¸ª")
        # å¤„ç†å›¾ç‰‡
        if image_files:
            self.load_images(image_files)

    # ---------------------- æ–‡ä»¶åŠ è½½ ----------------------
    def load_doc(self, path):
        """åŠ è½½Wordæ–‡æ¡£å¹¶æå–å›¾ç‰‡ï¼ˆåˆå§‹åŒ–settingsä¸ºå®Œæ•´å­—å…¸ï¼‰"""
        self.radio_word.setChecked(True)
        self.doc_path = path
        self.direct_images = []  # æ¸…ç©ºå›¾ç‰‡åˆ—è¡¨
        self.log(f"ğŸ“¥ åŠ è½½Wordæ–‡æ¡£: {os.path.basename(path)}")
        self.lbl_status.setText("åˆ†ææ–‡æ¡£ä¸­çš„å›¾ç‰‡...")
        self.lbl_status.setVisible(True)
        self.list_widget.setVisible(False)
        QApplication.processEvents()

        try:
            self.doc = Document(path)
            self.image_parts = []
            count = 0
            # æå–æ–‡æ¡£ä¸­çš„å›¾ç‰‡
            for rel in self.doc.part.rels.values():
                if "image" in rel.target_ref:
                    part = rel.target_part
                    # è¯†åˆ«å›¾ç‰‡æ ¼å¼
                    with io.BytesIO(part.blob) as bio:
                        pil_img = Image.open(bio)
                        pil_format, file_ext = get_image_format(pil_img)
                    # åˆå§‹åŒ–settingsä¸ºå®Œæ•´å­—å…¸ï¼ˆé¿å…åç»­ç¼–è¾‘ç¼ºå¤±å­—æ®µï¼‰
                    init_settings = DEFAULT_CONFIG.copy()
                    self.image_parts.append({
                        "type": "word",
                        "part": part,
                        "original": part.blob,
                        "processed": part.blob,
                        "settings": init_settings,  # åˆå§‹ä¸ºå®Œæ•´é»˜è®¤é…ç½®
                        "pil_format": pil_format,
                        "file_ext": file_ext
                    })
                    count += 1
            if count == 0:
                self.log("âš ï¸ Wordæ–‡æ¡£ä¸­æ— å›¾ç‰‡")
                self.lbl_status.setText("æ–‡æ¡£æ— å›¾ç‰‡")
                return
            # åŠ è½½æˆåŠŸ
            self.log(f"âœ… æå–åˆ° {count} å¼ å›¾ç‰‡ï¼ˆæ¥è‡ªWordï¼‰")
            self.lbl_status.setVisible(False)
            self.list_widget.setVisible(True)
            self.btn_apply.setEnabled(True)
            self.btn_export.setEnabled(True)
            self.update_file_list()
        except Exception as e:
            self.log(f"âŒ åŠ è½½Wordå¤±è´¥: {str(e)}")
            self.lbl_status.setText("åŠ è½½Wordå¤±è´¥")

    def load_images(self, paths):
        """åŠ è½½ç›´æ¥æ‹–å…¥çš„å›¾ç‰‡ï¼ˆåˆå§‹åŒ–settingsä¸ºå®Œæ•´å­—å…¸ï¼‰"""
        self.radio_image.setChecked(True)
        self.doc = None  # æ¸…ç©ºWord
        self.image_parts = []  # æ¸…ç©ºWordå›¾ç‰‡
        self.log(f"ğŸ“¥ åŠ è½½å›¾ç‰‡: å…± {len(paths)} å¼ ")
        self.lbl_status.setText("åŠ è½½å›¾ç‰‡ä¸­...")
        self.lbl_status.setVisible(True)
        self.list_widget.setVisible(False)
        QApplication.processEvents()

        try:
            self.direct_images = []
            for path in paths:
                with open(path, 'rb') as f:
                    original_data = f.read()
                # è¯†åˆ«æ ¼å¼
                pil_format, file_ext = get_image_format(path)
                # åˆå§‹åŒ–settingsä¸ºå®Œæ•´å­—å…¸ï¼ˆé¿å…åç»­ç¼–è¾‘ç¼ºå¤±å­—æ®µï¼‰
                init_settings = DEFAULT_CONFIG.copy()
                self.direct_images.append({
                    "type": "image",
                    "original_path": path,
                    "original_data": original_data,
                    "processed_data": original_data,
                    "pil_format": pil_format,
                    "file_ext": file_ext,
                    "settings": init_settings  # åˆå§‹ä¸ºå®Œæ•´é»˜è®¤é…ç½®
                })
            # åŠ è½½æˆåŠŸ
            self.log(f"âœ… åŠ è½½å®Œæˆ {len(self.direct_images)} å¼ å›¾ç‰‡")
            self.lbl_status.setVisible(False)
            self.list_widget.setVisible(True)
            self.btn_apply.setEnabled(True)
            self.btn_export.setEnabled(True)
            self.update_file_list()
        except Exception as e:
            self.log(f"âŒ åŠ è½½å›¾ç‰‡å¤±è´¥: {str(e)}")
            self.lbl_status.setText("åŠ è½½å›¾ç‰‡å¤±è´¥")

    # ---------------------- æ–‡ä»¶åˆ—è¡¨æ›´æ–° ----------------------
    def update_file_list(self):
        """æ›´æ–°å³ä¾§æ–‡ä»¶åˆ—è¡¨é¢„è§ˆ"""
        self.list_widget.clear()

        # 1. æ·»åŠ Wordä¸­çš„å›¾ç‰‡
        for i, item in enumerate(self.image_parts):
            try:
                with Image.open(io.BytesIO(item['processed'])) as pil_img:
                    # ç”Ÿæˆç¼©ç•¥å›¾
                    thumb = pil_img.copy()
                    thumb.thumbnail((200, 200))
                    thumb_io = io.BytesIO()
                    thumb.save(thumb_io, format=item['pil_format'], quality=80)
                    # è½¬ä¸ºQPixmap
                    qim = QImage.fromData(thumb_io.getvalue())
                    pix = QPixmap.fromImage(qim)
                    # åˆ¤æ–­æ˜¯å¦è·³è¿‡æ°´å°ï¼ˆsettingså·²è¡¥å…¨ï¼Œæ— KeyErrorï¼‰
                    settings = item.get('settings', {})
                    item_text = f"Wordå›¾ç‰‡ {i + 1} (.{item['file_ext']})"
                    if settings.get('skip_watermark'):
                        item_text += " [ä¸åŠ æ°´å°]"
                    # åˆ›å»ºåˆ—è¡¨é¡¹
                    list_item = QListWidgetItem(QIcon(pix), item_text)
                    list_item.setData(Qt.ItemDataRole.UserRole, ('word', i))
                    self.list_widget.addItem(list_item)
            except Exception as e:
                self.log(f"âš ï¸ ç”Ÿæˆé¢„è§ˆå¤±è´¥ (Wordå›¾ç‰‡ {i + 1}): {str(e)}")

        # 2. æ·»åŠ ç›´æ¥æ‹–å…¥çš„å›¾ç‰‡
        for i, item in enumerate(self.direct_images):
            try:
                with Image.open(io.BytesIO(item['processed_data'])) as pil_img:
                    # ç”Ÿæˆç¼©ç•¥å›¾
                    thumb = pil_img.copy()
                    thumb.thumbnail((200, 200))
                    thumb_io = io.BytesIO()
                    thumb.save(thumb_io, format=item['pil_format'], quality=80)
                    # è½¬ä¸ºQPixmap
                    qim = QImage.fromData(thumb_io.getvalue())
                    pix = QPixmap.fromImage(qim)
                    # åˆ¤æ–­æ˜¯å¦è·³è¿‡æ°´å°
                    settings = item.get('settings', {})
                    filename = os.path.basename(item['original_path'])
                    item_text = f"{filename} (.{item['file_ext']})"
                    if settings.get('skip_watermark'):
                        item_text += " [ä¸åŠ æ°´å°]"
                    # åˆ›å»ºåˆ—è¡¨é¡¹
                    list_item = QListWidgetItem(QIcon(pix), item_text)
                    list_item.setData(Qt.ItemDataRole.UserRole, ('image', i))
                    self.list_widget.addItem(list_item)
            except Exception as e:
                filename = os.path.basename(item['original_path']) if item.get('original_path') else "æœªçŸ¥å›¾ç‰‡"
                self.log(f"âš ï¸ ç”Ÿæˆé¢„è§ˆå¤±è´¥ ({filename}): {str(e)}")

    # ---------------------- æ‰¹é‡åº”ç”¨æ°´å° ----------------------
    def run_batch_process(self):
        """æ‰¹é‡åº”ç”¨æ°´å°ï¼ˆæ”¯æŒé‡å¤æ‰§è¡Œï¼‰"""
        # è·å–å½“å‰å…¨å±€è®¾ç½®ï¼ˆè¡¥å…¨åä¼ é€’ï¼‰
        global_settings = DEFAULT_CONFIG.copy()
        global_settings.update({
            "text": self.inp_text.text(),
            "size_percent": self.sl_size.value(),
            "opacity": self.sl_opacity.value(),
            "angle": self.sl_angle.value(),
            "color": self.config['color'],
            "fill_mode": self.cmb_fill_mode.currentData(),
            "offset_x": self.sl_offset_x.value(),
            "offset_y": self.sl_offset_y.value()
        })
        # ä¿å­˜é…ç½®ï¼ˆç¡®ä¿é…ç½®å®Œæ•´ï¼‰
        self.config = global_settings.copy()
        save_config(self.config)

        self.log("â³ å¼€å§‹æ‰¹é‡åº”ç”¨æ°´å°ï¼ˆæ”¯æŒé‡å¤æ‰§è¡Œï¼‰")
        self.progress.setVisible(True)
        self.btn_apply.setEnabled(False)
        self.btn_export.setEnabled(False)

        # å¤„ç†Wordå›¾ç‰‡
        if self.radio_word.isChecked() and self.image_parts:
            total = len(self.image_parts)
            self.progress.setRange(0, total)
            for i, item in enumerate(self.image_parts):
                self.progress.setValue(i)
                # è¡¥å…¨å›¾ç‰‡è‡ªèº«çš„settingsï¼ˆé¿å…ç¼ºå¤±å­—æ®µï¼‰
                current_settings = DEFAULT_CONFIG.copy()
                if item.get('settings'):
                    current_settings.update(item['settings'])
                # è‹¥è®¾ç½®äº†skip_watermarkï¼Œè·³è¿‡å½“å‰å›¾ç‰‡
                if current_settings.get('skip_watermark'):
                    self.log(f"â­ï¸ è·³è¿‡ Wordå›¾ç‰‡ {i + 1}ï¼ˆå·²è®¾ç½®ä¸åŠ æ°´å°ï¼‰")
                    continue
                try:
                    with io.BytesIO(item['original']) as bio:  # åŸºäºåŸå›¾é‡æ–°å¤„ç†ï¼ˆæ”¯æŒé‡å¤ï¼‰
                        pil_img = Image.open(bio)
                        pil_format, file_ext = get_image_format(pil_img)
                        res_pil = apply_watermark_to_image(pil_img, current_settings)
                        out_io = io.BytesIO()
                        if pil_format == 'JPEG' and res_pil.mode == 'RGBA':
                            res_pil = res_pil.convert('RGB')
                        res_pil.save(out_io, format=pil_format, quality=90)
                        # æ›´æ–°æ•°æ®ï¼ˆä¿å­˜è¡¥å…¨åçš„settingsï¼‰
                        item['processed'] = out_io.getvalue()
                        item['settings'] = current_settings
                        item['pil_format'] = pil_format
                        item['file_ext'] = file_ext
                except Exception as e:
                    self.log(f"âš ï¸ å¤„ç†å¤±è´¥ (Wordå›¾ç‰‡ {i + 1}): {str(e)}")
            # å¤„ç†å®Œæˆ
            self.progress.setValue(total)
            self.log("âœ… Wordå›¾ç‰‡æ°´å°åº”ç”¨å®Œæˆ")
            self.update_file_list()
            self.btn_apply.setEnabled(True)
            self.btn_export.setEnabled(True)

        # å¤„ç†ç›´æ¥æ‹–å…¥çš„å›¾ç‰‡ï¼ˆçº¿ç¨‹ï¼‰
        elif self.radio_image.isChecked() and self.direct_images:
            image_paths = [item['original_path'] for item in self.direct_images]
            self.process_thread = ImageProcessThread(image_paths, global_settings)
            self.process_thread.progress_update.connect(self.on_process_progress)
            self.process_thread.finished_signal.connect(self.on_image_process_finished)
            self.process_thread.error_signal.connect(self.log)
            self.process_thread.start()

        else:
            # æ— æ–‡ä»¶å¯å¤„ç†
            self.progress.setVisible(False)
            self.btn_apply.setEnabled(True)
            self.btn_export.setEnabled(True)

    @pyqtSlot(int)
    def on_process_progress(self, value):
        """æ›´æ–°å›¾ç‰‡å¤„ç†è¿›åº¦"""
        self.progress.setRange(0, 100)
        self.progress.setValue(value)

    @pyqtSlot(list)
    def on_image_process_finished(self, processed_images):
        """å›¾ç‰‡å¤„ç†çº¿ç¨‹å®Œæˆ"""
        # æ›´æ–°å›¾ç‰‡æ•°æ®ï¼ˆä¿å­˜è¡¥å…¨åçš„settingsï¼‰
        for processed_img in processed_images:
            for original_img in self.direct_images:
                if processed_img['original_path'] == original_img['original_path']:
                    # ä¿ç•™åŸå›¾ç‰‡çš„skip_watermarkè®¾ç½®ï¼ˆå¦‚æœ‰ï¼‰
                    final_settings = processed_img['settings'].copy()
                    if original_img.get('settings', {}).get('skip_watermark'):
                        final_settings['skip_watermark'] = True
                    original_img.update({
                        "processed_data": processed_img['processed_data'],
                        "settings": final_settings,
                        "pil_format": processed_img['pil_format'],
                        "file_ext": processed_img['file_ext']
                    })
                    break
        self.log("âœ… å›¾ç‰‡æ°´å°åº”ç”¨å®Œæˆï¼ˆæ”¯æŒé‡å¤æ‰§è¡Œï¼‰")
        self.update_file_list()
        self.btn_apply.setEnabled(True)
        self.btn_export.setEnabled(True)
        self.progress.setVisible(False)

    # ---------------------- æ–‡ä»¶å¯¼å‡ºï¼ˆè¡¥å…¨ä¸­æ–­çš„è·¨å¹³å°ç›®å½•æ‰“å¼€é€»è¾‘ï¼‰----------------------
    def export_files(self):
        """å¯¼å‡ºå¤„ç†åçš„æ–‡ä»¶"""
        # å¯¼å‡ºWord
        if self.radio_word.isChecked() and self.doc and self.image_parts:
            default_name = os.path.splitext(self.doc_path)[0] + "_æ°´å°ç‰ˆ.docx"
            save_path, _ = QFileDialog.getSaveFileName(
                self, "ä¿å­˜Wordæ–‡æ¡£", default_name, "Wordæ–‡æ¡£ (*.docx)"
            )
            if not save_path:
                return
            self.log(f"ğŸ’¾ ä¿å­˜Word: {os.path.basename(save_path)}")
            try:
                # æ›¿æ¢æ–‡æ¡£ä¸­çš„å›¾ç‰‡
                for item in self.image_parts:
                    item['part']._blob = item['processed']
                self.doc.save(save_path)
                self.log("ğŸ‰ Wordå¯¼å‡ºæˆåŠŸ")
                QMessageBox.information(self, "æˆåŠŸ", f"Wordä¿å­˜è‡³:\n{save_path}")
            except Exception as e:
                self.log(f"âŒ Wordä¿å­˜å¤±è´¥: {str(e)}")
                QMessageBox.critical(self, "å¤±è´¥", str(e))

        # å¯¼å‡ºå›¾ç‰‡ï¼ˆè‡ªåŠ¨è·¯å¾„ï¼Œè¡¥å…¨è·¨å¹³å°ç›®å½•æ‰“å¼€é€»è¾‘ï¼‰
        elif self.radio_image.isChecked() and self.direct_images:
            self.log("ğŸ’¾ å¼€å§‹å¯¼å‡ºå›¾ç‰‡ï¼ˆè‡ªåŠ¨è·¯å¾„ï¼šåŸæ–‡ä»¶å¤¹/å·²åŠ æ°´å°å›¾ç‰‡ï¼‰")
            self.progress.setVisible(True)
            self.progress.setRange(0, len(self.direct_images))
            success_count = 0
            failed_files = []
            output_dirs = set()

            for i, img_item in enumerate(self.direct_images):
                self.progress.setValue(i)
                try:
                    # è¡¥å…¨settingsï¼Œé¿å…åˆ¤æ–­æ—¶ç¼ºå¤±å­—æ®µ
                    settings = img_item.get('settings', {})
                    skip_watermark = settings.get('skip_watermark', False)
                    export_data = img_item['original_data'] if skip_watermark else img_item['processed_data']
                    if skip_watermark:
                        self.log(f"â­ï¸ è·³è¿‡æ°´å°: {os.path.basename(img_item['original_path'])}")

                    # æ„å»ºå¯¼å‡ºè·¯å¾„
                    original_path = img_item['original_path']
                    original_dir = os.path.dirname(original_path)
                    filename_no_ext = os.path.splitext(os.path.basename(original_path))[0]
                    file_ext = img_item['file_ext']
                    # è¾“å‡ºç›®å½•ï¼šåŸæ–‡ä»¶å¤¹/å·²åŠ æ°´å°å›¾ç‰‡
                    output_dir = os.path.join(original_dir, "å·²åŠ æ°´å°å›¾ç‰‡")
                    os.makedirs(output_dir, exist_ok=True)
                    output_dirs.add(output_dir)

                    # é¿å…æ–‡ä»¶åé‡å¤ï¼ˆåŠ æ—¶é—´æˆ³ï¼‰
                    output_filename = f"{filename_no_ext}_æ°´å°.{file_ext}"
                    output_path = os.path.join(output_dir, output_filename)
                    if os.path.exists(output_path):
                        timestamp = datetime.now().strftime("%H%M%S")
                        output_filename = f"{filename_no_ext}_æ°´å°_{timestamp}.{file_ext}"
                        output_path = os.path.join(output_dir, output_filename)

                    # ä¿å­˜å›¾ç‰‡
                    with open(output_path, 'wb') as f:
                        f.write(export_data)
                    success_count += 1
                    self.log(f"âœ… ä¿å­˜æˆåŠŸ: {os.path.basename(output_path)}")
                except Exception as e:
                    err_msg = f"{os.path.basename(img_item['original_path'])}: {str(e)}"
                    self.log(f"âš ï¸ ä¿å­˜å¤±è´¥: {err_msg}")
                    failed_files.append(err_msg)

            # å¯¼å‡ºå®Œæˆ
            self.progress.setValue(len(self.direct_images))
            self.progress.setVisible(False)
            # æ˜¾ç¤ºç»“æœ
            result_msg = f"ğŸ‰ å›¾ç‰‡å¯¼å‡ºå®Œæˆï¼\næˆåŠŸ: {success_count}/{len(self.direct_images)} å¼ \n\nè¾“å‡ºç›®å½•ï¼š"
            for dir_path in output_dirs:
                result_msg += f"\nâ€¢ {dir_path}"
            # æ˜¾ç¤ºå¤±è´¥ä¿¡æ¯ï¼ˆå‰5ä¸ªï¼‰
            if failed_files:
                result_msg += f"\n\nâš ï¸ å¤±è´¥ ({len(failed_files)} ä¸ª):"
                for err in failed_files[:5]:
                    result_msg += f"\nâ€¢ {err}"
                if len(failed_files) > 5:
                    result_msg += f"\nâ€¢ è¿˜æœ‰ {len(failed_files) - 5} ä¸ªå¤±è´¥ï¼ˆè§æ—¥å¿—ï¼‰"
            QMessageBox.information(self, "å¯¼å‡ºæˆåŠŸ", result_msg)

            # è¡¥å…¨è·¨å¹³å°è‡ªåŠ¨æ‰“å¼€ç›®å½•é€»è¾‘ï¼ˆWindows/Mac/Linuxï¼‰
            if output_dirs:
                first_dir = next(iter(output_dirs))
                try:
                    if platform.system() == "Windows":
                        os.startfile(first_dir)
                    elif platform.system() == "Darwin":  # MacOS
                        os.system(f"open '{first_dir}'")
                    else:  # Linux
                        os.system(f"xdg-open '{first_dir}'")
                    self.log(f"ğŸ“‚ å·²è‡ªåŠ¨æ‰“å¼€è¾“å‡ºç›®å½•: {first_dir}")
                except Exception as e:
                    self.log(f"âš ï¸ è‡ªåŠ¨æ‰“å¼€ç›®å½•å¤±è´¥: {str(e)}ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€: {first_dir}")


# --- ç¨‹åºå…¥å£ï¼ˆå®Œæ•´é—­åˆï¼‰---
if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = MainWindow()
    window.show()
    sys.exit(app.exec())