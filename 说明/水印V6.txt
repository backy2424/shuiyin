import sys
import os
import io
import json
import platform
import math
import time
from datetime import datetime
from docx import Document
from PyQt6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
                             QLabel, QPushButton, QSlider, QLineEdit, QFileDialog,
                             QListWidget, QListWidgetItem, QColorDialog, QDialog,
                             QDialogButtonBox, QMessageBox, QFormLayout, QPlainTextEdit, QProgressBar,
                             QComboBox, QMenu, QFrame, QGroupBox, QRadioButton)
from PyQt6.QtCore import Qt, QSize, QPoint, pyqtSignal, QEvent, QThread, pyqtSlot
from PyQt6.QtGui import QPixmap, QImage, QIcon, QDragEnterEvent, QDropEvent, QAction, QColor, QMouseEvent, QPainter, \
    QFont
from PIL import Image, ImageDraw, ImageFont

# ä½¿ç”¨ pip å®‰è£…æ‰€éœ€åº“
# pip install python-docx PyQt6 Pillow

# --- é…ç½®ç®¡ç† ---
CONFIG_FILE = "wm_settings.json"
DEFAULT_CONFIG = {
    "text": "å†…éƒ¨æœºå¯†",
    "size_percent": 5,
    "opacity": 50,
    "angle": 45,
    "color": "#FF0000",
    "fill_mode": "single",
    "offset_x": 0,
    "offset_y": 0
}


def load_config():
    """åŠ è½½é…ç½®ï¼Œå¹¶ç¡®ä¿å…¼å®¹æ—§ç‰ˆæœ¬æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰é»˜è®¤é”®ã€‚"""
    config = DEFAULT_CONFIG.copy()
    if os.path.exists(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                loaded_config = json.load(f)
                for key, default_value in DEFAULT_CONFIG.items():
                    if key in loaded_config:
                        config[key] = loaded_config[key]
                return config
        except Exception as e:
            print(f"Error loading config file: {e}. Using default settings.")
    return config


def save_config(config):
    """ä¿å­˜å½“å‰é…ç½®åˆ°æ–‡ä»¶ã€‚"""
    with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
        json.dump(config, f, ensure_ascii=False, indent=4)


# --- è¾…åŠ©å‡½æ•°ï¼šè·å–ç³»ç»Ÿå­—ä½“ ---
def get_default_font_path():
    """å°è¯•è·å–ä¸€ä¸ªå¸¸è§çš„ä¸­æ–‡å­—ä½“è·¯å¾„ã€‚"""
    system = platform.system()
    if system == "Windows":
        fonts = ["msyh.ttc", "simhei.ttf", "arial.ttf"]
        font_dir = "C:\\Windows\\Fonts"
        for f in fonts:
            path = os.path.join(font_dir, f)
            if os.path.exists(path):
                return path
    elif system == "Darwin":  # MacOS
        return "/System/Library/Fonts/PingFang.ttc"
    elif system == "Linux":
        return "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf"
    return None


# --- è¾…åŠ©å‡½æ•°ï¼šå›¾ç‰‡æ ¼å¼éªŒè¯ ---
def is_supported_image(path):
    """åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸ºæ”¯æŒçš„å›¾ç‰‡æ ¼å¼"""
    supported_formats = ('.png', '.jpg', '.jpeg', '.bmp', '.gif', '.tiff')
    return path.lower().endswith(supported_formats)


# --- æ ¸å¿ƒæ°´å°é€»è¾‘ï¼ˆä¼˜åŒ–æ—‹è½¬ä¸­å¿ƒï¼‰---
def apply_watermark_to_image(pil_image, settings):
    """æ ¹æ®è®¾ç½®å¯¹PIL Imageå¯¹è±¡æ·»åŠ æ°´å°ã€‚ä¼˜åŒ–ï¼šä»¥æ°´å°æ–‡å­—ä¸­å¿ƒä¸ºæ—‹è½¬ä¸­å¿ƒ"""
    # å¤„ç†è·³è¿‡æ°´å°çš„æƒ…å†µ
    if isinstance(settings, dict) and settings.get('skip_watermark', False):
        return pil_image

    base_image = pil_image.convert("RGBA")
    width, height = base_image.size
    txt_layer = Image.new("RGBA", base_image.size, (255, 255, 255, 0))
    draw = ImageDraw.Draw(txt_layer)

    # å­—ä½“å¤§å°è®¡ç®—
    font_size = max(10, int(width * (settings.get('size_percent', 5) / 100)))
    font_path = get_default_font_path()
    try:
        font = ImageFont.truetype(font_path, font_size) if font_path else ImageFont.load_default()
    except Exception:
        font = ImageFont.load_default()

    # åŸºç¡€å‚æ•°
    text = settings['text']
    opacity = int(settings['opacity'] * 255 / 100)
    hex_color = settings['color'].lstrip('#')
    try:
        rgb = tuple(int(hex_color[i:i + 2], 16) for i in (0, 2, 4))
    except:
        rgb = (255, 0, 0)
    fill_color = rgb + (opacity,)

    # è®¡ç®—æ–‡å­—å°ºå¯¸å’Œä¸­å¿ƒç‚¹
    try:
        bbox = draw.textbbox((0, 0), text, font=font)  # (left, top, right, bottom)
        text_w = bbox[2] - bbox[0]
        text_h = bbox[3] - bbox[1]
        text_center_x = text_w / 2  # æ–‡å­—è‡ªèº«çš„ä¸­å¿ƒç‚¹X
        text_center_y = text_h / 2  # æ–‡å­—è‡ªèº«çš„ä¸­å¿ƒç‚¹Y
    except:
        text_w, text_h = draw.textsize(text, font=font)
        text_center_x = text_w / 2
        text_center_y = text_h / 2

    # åç§»é‡è½¬æ¢ï¼ˆç™¾åˆ†æ¯”â†’åƒç´ ï¼‰
    fill_mode = settings.get('fill_mode', 'single')
    offset_x_px = settings.get('offset_x', 0) / 100 * width
    offset_y_px = settings.get('offset_y', 0) / 100 * height

    # è®¡ç®—æ–‡å­—ç»˜åˆ¶çš„åŸºå‡†ä½ç½®ï¼ˆå›¾ç‰‡ä¸­å¿ƒ + åç§»ï¼‰
    base_x = (width / 2) - text_center_x + offset_x_px  # è®©æ–‡å­—ä¸­å¿ƒå¯¹é½å›¾ç‰‡ä¸­å¿ƒï¼ˆåŠ åç§»ï¼‰
    base_y = (height / 2) - text_center_y + offset_y_px

    if fill_mode == 'single':
        # å•ä¸ªæ°´å°ï¼šç›´æ¥ç»˜åˆ¶åœ¨åŸºå‡†ä½ç½®
        draw.text((base_x, base_y), text, font=font, fill=fill_color)
    elif fill_mode == 'tiled':
        # å¹³é“ºæ°´å°ï¼šåŸºäºåŸºå‡†ä½ç½®ç”Ÿæˆç½‘æ ¼
        spacing_x = int(text_w * 1.5)
        spacing_y = int(text_h * 2.5)
        # è®¡ç®—èµ·å§‹ä½ç½®ï¼ˆç¡®ä¿å·¦ä¸Šè§’èƒ½è¦†ç›–åˆ°ï¼‰
        start_x = base_x - (base_x // spacing_x) * spacing_x
        start_y = base_y - (base_y // spacing_y) * spacing_y
        # ç»˜åˆ¶å¹³é“ºç½‘æ ¼
        for i in range(-1, int(width / spacing_x) + 2):
            for j in range(-1, int(height / spacing_y) + 2):
                x = start_x + i * spacing_x
                y = start_y + j * spacing_y
                draw.text((x, y), text, font=font, fill=fill_color)

    # ä¼˜åŒ–æ—‹è½¬ï¼šä»¥æ–‡å­—ä¸­å¿ƒä¸ºæ—‹è½¬ä¸­å¿ƒï¼ˆè€Œéå›¾ç‰‡ä¸­å¿ƒï¼‰
    angle = settings['angle']
    if angle != 0:
        # è®¡ç®—æ–‡å­—åœ¨ç”»å¸ƒä¸Šçš„å®é™…ä¸­å¿ƒç‚¹åæ ‡ï¼ˆåŸºå‡†ä½ç½® + æ–‡å­—è‡ªèº«ä¸­å¿ƒï¼‰
        canvas_text_center_x = base_x + text_center_x
        canvas_text_center_y = base_y + text_center_y
        # æ—‹è½¬æ—¶ä»¥æ–‡å­—ä¸­å¿ƒä¸ºè½´å¿ƒ
        txt_layer = txt_layer.rotate(
            angle,
            center=(canvas_text_center_x, canvas_text_center_y),  # ä¼˜åŒ–ï¼šæ–‡å­—ä¸­å¿ƒä½œä¸ºæ—‹è½¬ä¸­å¿ƒ
            expand=False,
            resample=Image.Resampling.BICUBIC  # æŠ—é”¯é½¿
        )

    # åˆå¹¶å›¾å±‚
    out = Image.alpha_composite(base_image, txt_layer)
    return out


# --- å¯æ‹–æ‹½çš„é¢„è§ˆQLabelï¼ˆä¼˜åŒ–æ‹–æ‹½æ–¹å‘ï¼‰---
class DraggablePreviewLabel(QLabel):
    offsetChanged = pyqtSignal(int, int)

    def __init__(self, parent=None):
        super().__init__(parent)
        self.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.setStyleSheet("background-color: #333; border: 1px solid #555;")
        self._pixmap_original = None
        self._current_settings = {}
        self._watermarked_pixmap = None
        self._start_pos = None
        self._current_offset_x = 0
        self._current_offset_y = 0
        self.setMouseTracking(False)
        self.setCursor(Qt.CursorShape.OpenHandCursor)

    def set_image(self, pil_image):
        """è®¾ç½®è¦é¢„è§ˆçš„åŸå§‹å›¾ç‰‡ã€‚"""
        self._pixmap_original = pil_image.copy()
        self.update_watermark_display()

    def set_settings(self, settings):
        """è®¾ç½®æ°´å°å‚æ•°ï¼Œå¹¶è§¦å‘æ›´æ–°ã€‚"""
        self._current_settings = settings.copy()
        self._current_offset_x = self._current_settings.get('offset_x', 0)
        self._current_offset_y = self._current_settings.get('offset_y', 0)
        self.update_watermark_display()

    def update_watermark_display(self):
        """æ ¹æ®å½“å‰å›¾ç‰‡å’Œè®¾ç½®ç”Ÿæˆå¸¦æ°´å°çš„å›¾ç‰‡å¹¶æ˜¾ç¤ºã€‚"""
        if self._pixmap_original is None:
            pix = QPixmap(self.size())
            pix.fill(QColor("#333333"))
            painter = QPainter(pix)
            painter.setPen(QColor("#AAAAAA"))
            painter.setFont(QFont("Arial", 16))
            painter.drawText(self.rect(), Qt.AlignmentFlag.AlignCenter, "ç­‰å¾…æ‹–å…¥å›¾ç‰‡æˆ–Wordæ–‡æ¡£...")
            painter.end()
            self.setPixmap(pix)
            return

        display_settings = self._current_settings.copy()
        display_settings['offset_x'] = self._current_offset_x
        display_settings['offset_y'] = self._current_offset_y

        try:
            watermarked_pil = apply_watermark_to_image(self._pixmap_original, display_settings)
            im_data = watermarked_pil.convert("RGBA").tobytes("raw", "RGBA")
            qim = QImage(im_data, watermarked_pil.width, watermarked_pil.height, QImage.Format.Format_RGBA8888)
            self._watermarked_pixmap = QPixmap.fromImage(qim)
            self.setPixmap(self._watermarked_pixmap.scaled(
                self.size(),
                Qt.AspectRatioMode.KeepAspectRatio,
                Qt.TransformationMode.SmoothTransformation
            ))
        except Exception as e:
            print(f"æ°´å°æ¸²æŸ“é”™è¯¯: {e}")

    def resizeEvent(self, event: QEvent):
        """å½“QLabelå¤§å°æ”¹å˜æ—¶ï¼Œé‡æ–°ç»˜åˆ¶æ°´å°ä»¥é€‚åº”æ–°å°ºå¯¸ã€‚"""
        super().resizeEvent(event)
        self.update_watermark_display()

    def mousePressEvent(self, event: QMouseEvent):
        if event.button() == Qt.MouseButton.LeftButton and self._pixmap_original:
            self._start_pos = event.pos()
            self.setCursor(Qt.CursorShape.ClosedHandCursor)

    def mouseMoveEvent(self, event: QMouseEvent):
        if self._start_pos and event.buttons() & Qt.MouseButton.LeftButton and self._pixmap_original:
            # 1. è®¡ç®—é¼ æ ‡åœ¨é¢„è§ˆåŒºçš„ç›¸å¯¹ç§»åŠ¨é‡ï¼ˆå±å¹•åæ ‡ï¼‰
            delta_screen = event.pos() - self._start_pos

            # 2. è·å–ç¼©æ”¾æ¯”ä¾‹ï¼ˆé¢„è§ˆå›¾ â†’ åŸå§‹å›¾ï¼‰
            original_width = self._pixmap_original.width
            original_height = self._pixmap_original.height
            current_pixmap = self.pixmap()

            if current_pixmap and not current_pixmap.isNull():
                scaled_size = current_pixmap.size()
                scale_x = original_width / scaled_size.width() if scaled_size.width() > 0 else 1.0
                scale_y = original_height / scaled_size.height() if scaled_size.height() > 0 else 1.0
            else:
                scale_x = scale_y = 1.0

            # 3. ä¼˜åŒ–æ‹–æ‹½æ–¹å‘ï¼šå°†å±å¹•ç§»åŠ¨é‡è½¬æ¢ä¸ºåŸå§‹å›¾çš„åƒç´ ç§»åŠ¨ï¼ˆä¸ä¾èµ–æ—‹è½¬è§’åº¦ï¼‰
            # æ ¸å¿ƒé€»è¾‘ï¼šæ‹–æ‹½æ–¹å‘å§‹ç»ˆä¸é¼ æ ‡ç§»åŠ¨æ–¹å‘ä¸€è‡´ï¼Œå¿½ç•¥æ°´å°æ—‹è½¬è§’åº¦
            delta_x_img_px = delta_screen.x() * scale_x
            delta_y_img_px = delta_screen.y() * scale_y

            # 4. è½¬æ¢ä¸ºç™¾åˆ†æ¯”åç§»ï¼ˆç›¸å¯¹äºåŸå§‹å›¾ç‰‡å°ºå¯¸ï¼‰
            delta_x_percent = (delta_x_img_px / original_width) * 100
            delta_y_percent = (delta_y_img_px / original_height) * 100

            # 5. æ›´æ–°åç§»é‡ï¼ˆé™åˆ¶èŒƒå›´ï¼‰
            self._current_offset_x = max(-200, min(200, self._current_offset_x + delta_x_percent))
            self._current_offset_y = max(-200, min(200, self._current_offset_y + delta_y_percent))

            # 6. è§¦å‘æ›´æ–°
            self._start_pos = event.pos()
            self.offsetChanged.emit(int(self._current_offset_x), int(self._current_offset_y))
            self.update_watermark_display()

        super().mouseMoveEvent(event)

    def mouseReleaseEvent(self, event: QMouseEvent):
        self._start_pos = None
        self.setCursor(Qt.CursorShape.OpenHandCursor)


# --- å•ç‹¬ç¼–è¾‘å¯¹è¯æ¡† ---
class EditDialog(QDialog):
    def __init__(self, image_data, current_settings, parent=None):
        super().__init__(parent)
        self.setWindowTitle("å•ç‹¬å¾®è°ƒå›¾ç‰‡")
        self.resize(900, 600)
        self.original_pil = Image.open(io.BytesIO(image_data)) if isinstance(image_data, bytes) else image_data
        self.settings = current_settings.copy()
        main_layout = QHBoxLayout(self)

        self.preview_label = QLabel()
        self.preview_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.preview_label.setStyleSheet("background-color: #333;")
        main_layout.addWidget(self.preview_label, stretch=2)

        ctrl = QWidget()
        form = QFormLayout(ctrl)
        self.inp_text = QLineEdit(self.settings['text'])
        self.inp_text.textChanged.connect(self.update_preview)
        form.addRow("æ–‡å­—:", self.inp_text)

        self.sl_size = QSlider(Qt.Orientation.Horizontal)
        self.sl_size.setRange(1, 50)
        self.sl_size.setValue(self.settings.get('size_percent', 5))
        self.sl_size.valueChanged.connect(self.update_preview)
        form.addRow("å¤§å° (ç›¸å¯¹æ¯”ä¾‹):", self.sl_size)

        self.sl_opacity = QSlider(Qt.Orientation.Horizontal)
        self.sl_opacity.setRange(0, 100)
        self.sl_opacity.setValue(self.settings['opacity'])
        self.sl_opacity.valueChanged.connect(self.update_preview)
        form.addRow("é€æ˜åº¦:", self.sl_opacity)

        self.sl_angle = QSlider(Qt.Orientation.Horizontal)
        self.sl_angle.setRange(0, 360)
        self.sl_angle.setValue(self.settings['angle'])
        self.sl_angle.valueChanged.connect(self.update_preview)
        form.addRow("æ—‹è½¬è§’åº¦:", self.sl_angle)

        self.sl_offset_x = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_x.setRange(-200, 200)
        self.sl_offset_x.setValue(self.settings.get('offset_x', 0))
        self.sl_offset_x.valueChanged.connect(self.update_preview)
        form.addRow("Xè½´åç§» (%):", self.sl_offset_x)

        self.sl_offset_y = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_y.setRange(-200, 200)
        self.sl_offset_y.setValue(self.settings.get('offset_y', 0))
        self.sl_offset_y.valueChanged.connect(self.update_preview)
        form.addRow("Yè½´åç§» (%):", self.sl_offset_y)

        self.cmb_fill_mode = QComboBox()
        self.cmb_fill_mode.addItem("å•ä¸ª (å±…ä¸­)", "single")
        self.cmb_fill_mode.addItem("å¹³é“º (é‡å¤)", "tiled")
        idx = self.cmb_fill_mode.findData(self.settings['fill_mode'])
        if idx != -1: self.cmb_fill_mode.setCurrentIndex(idx)
        self.cmb_fill_mode.currentIndexChanged.connect(self.update_preview)
        form.addRow("å¡«å……æ¨¡å¼:", self.cmb_fill_mode)

        btns = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel)
        btns.accepted.connect(self.accept)
        btns.rejected.connect(self.reject)
        form.addRow(btns)

        main_layout.addWidget(ctrl, stretch=1)
        self.update_preview()

    def update_preview(self):
        self.settings['text'] = self.inp_text.text()
        self.settings['size_percent'] = self.sl_size.value()
        self.settings['opacity'] = self.sl_opacity.value()
        self.settings['angle'] = self.sl_angle.value()
        self.settings['offset_x'] = self.sl_offset_x.value()
        self.settings['offset_y'] = self.sl_offset_y.value()
        self.settings['fill_mode'] = self.cmb_fill_mode.currentData()

        img = apply_watermark_to_image(self.original_pil, self.settings)
        im_data = img.convert("RGBA").tobytes("raw", "RGBA")
        qim = QImage(im_data, img.width, img.height, QImage.Format.Format_RGBA8888)
        pix = QPixmap.fromImage(qim)
        self.preview_label.setPixmap(pix.scaled(
            self.preview_label.size(),
            Qt.AspectRatioMode.KeepAspectRatio,
            Qt.TransformationMode.SmoothTransformation
        ))

    def get_settings(self):
        return self.settings


# --- æ‰¹é‡ç¼–è¾‘å¯¹è¯æ¡† ---
class BatchEditDialog(QDialog):
    def __init__(self, preview_image, current_settings, parent=None):
        super().__init__(parent)
        self.setWindowTitle("æ‰¹é‡ä¿®æ”¹æ°´å°")
        self.resize(900, 600)
        self.original_pil = preview_image
        self.settings = current_settings.copy()
        main_layout = QHBoxLayout(self)

        self.preview_label = QLabel()
        self.preview_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.preview_label.setStyleSheet("background-color: #333;")
        main_layout.addWidget(self.preview_label, stretch=2)

        ctrl = QWidget()
        form = QFormLayout(ctrl)
        self.inp_text = QLineEdit(self.settings['text'])
        self.inp_text.textChanged.connect(self.update_preview)
        form.addRow("æ–‡å­—:", self.inp_text)

        self.sl_size = QSlider(Qt.Orientation.Horizontal)
        self.sl_size.setRange(1, 50)
        self.sl_size.setValue(self.settings.get('size_percent', 5))
        self.sl_size.valueChanged.connect(self.update_preview)
        form.addRow("å¤§å° (ç›¸å¯¹æ¯”ä¾‹):", self.sl_size)

        self.sl_opacity = QSlider(Qt.Orientation.Horizontal)
        self.sl_opacity.setRange(0, 100)
        self.sl_opacity.setValue(self.settings['opacity'])
        self.sl_opacity.valueChanged.connect(self.update_preview)
        form.addRow("é€æ˜åº¦:", self.sl_opacity)

        self.sl_angle = QSlider(Qt.Orientation.Horizontal)
        self.sl_angle.setRange(0, 360)
        self.sl_angle.setValue(self.settings['angle'])
        self.sl_angle.valueChanged.connect(self.update_preview)
        form.addRow("æ—‹è½¬è§’åº¦:", self.sl_angle)

        self.sl_offset_x = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_x.setRange(-200, 200)
        self.sl_offset_x.setValue(self.settings.get('offset_x', 0))
        self.sl_offset_x.valueChanged.connect(self.update_preview)
        form.addRow("Xè½´åç§» (%):", self.sl_offset_x)

        self.sl_offset_y = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_y.setRange(-200, 200)
        self.sl_offset_y.setValue(self.settings.get('offset_y', 0))
        self.sl_offset_y.valueChanged.connect(self.update_preview)
        form.addRow("Yè½´åç§» (%):", self.sl_offset_y)

        self.cmb_fill_mode = QComboBox()
        self.cmb_fill_mode.addItem("å•ä¸ª (å±…ä¸­)", "single")
        self.cmb_fill_mode.addItem("å¹³é“º (é‡å¤)", "tiled")
        idx = self.cmb_fill_mode.findData(self.settings['fill_mode'])
        if idx != -1: self.cmb_fill_mode.setCurrentIndex(idx)
        self.cmb_fill_mode.currentIndexChanged.connect(self.update_preview)
        form.addRow("å¡«å……æ¨¡å¼:", self.cmb_fill_mode)

        btns = QDialogButtonBox(QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel)
        btns.accepted.connect(self.accept)
        btns.rejected.connect(self.reject)
        form.addRow(btns)

        main_layout.addWidget(ctrl, stretch=1)
        self.update_preview()

    def update_preview(self):
        self.settings['text'] = self.inp_text.text()
        self.settings['size_percent'] = self.sl_size.value()
        self.settings['opacity'] = self.sl_opacity.value()
        self.settings['angle'] = self.sl_angle.value()
        self.settings['offset_x'] = self.sl_offset_x.value()
        self.settings['offset_y'] = self.sl_offset_y.value()
        self.settings['fill_mode'] = self.cmb_fill_mode.currentData()

        img = apply_watermark_to_image(self.original_pil, self.settings)
        im_data = img.convert("RGBA").tobytes("raw", "RGBA")
        qim = QImage(im_data, img.width, img.height, QImage.Format.Format_RGBA8888)
        pix = QPixmap.fromImage(qim)
        self.preview_label.setPixmap(pix.scaled(
            self.preview_label.size(),
            Qt.AspectRatioMode.KeepAspectRatio,
            Qt.TransformationMode.SmoothTransformation
        ))

    def get_settings(self):
        return self.settings


# --- å›¾ç‰‡å¤„ç†çº¿ç¨‹ï¼ˆé¿å…UIé˜»å¡ï¼‰---
class ImageProcessThread(QThread):
    progress_update = pyqtSignal(int)
    finished_signal = pyqtSignal(list)
    error_signal = pyqtSignal(str)

    def __init__(self, image_paths, global_settings):
        super().__init__()
        self.image_paths = image_paths
        self.global_settings = global_settings

    def run(self):
        processed_images = []
        total = len(self.image_paths)

        for i, path in enumerate(self.image_paths):
            try:
                # è¯»å–åŸå§‹å›¾ç‰‡
                with open(path, 'rb') as f:
                    original_data = f.read()

                # å¤„ç†æ°´å°
                with Image.open(io.BytesIO(original_data)) as pil_img:
                    watermarked_img = apply_watermark_to_image(pil_img, self.global_settings)

                    # è½¬æ¢ä¸ºå­—èŠ‚æµ
                    out_io = io.BytesIO()
                    # å¼ºåˆ¶ç»Ÿä¸€è¾“å‡ºä¸ºPNGæ ¼å¼ï¼ˆä¿®å¤JPEGå…¼å®¹æ€§é—®é¢˜ï¼‰
                    watermarked_img.save(out_io, format="PNG")
                    processed_data = out_io.getvalue()

                processed_images.append({
                    "original_path": path,
                    "original_data": original_data,
                    "processed_data": processed_data,
                    "format": "PNG",  # ç»Ÿä¸€è®¾ç½®ä¸ºPNG
                    "settings": self.global_settings.copy()
                })

                self.progress_update.emit(int((i + 1) / total * 100))

            except Exception as e:
                self.error_signal.emit(f"å¤„ç†å›¾ç‰‡ {os.path.basename(path)} æ—¶å‡ºé”™: {str(e)}")

        self.finished_signal.emit(processed_images)


# --- ä¸»ç¨‹åº ---
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("å›¾ç‰‡/Wordæ‰¹é‡æ°´å°å·¥å…· v5.1 (è‡ªåŠ¨ä¿å­˜åˆ°åŸæ–‡ä»¶å¤¹)")
        self.resize(1200, 800)
        self.setAcceptDrops(True)
        self.config = load_config()
        self.doc = None
        self.doc_path = None
        self.image_parts = []  # å­˜å‚¨Wordæ–‡æ¡£ä¸­çš„å›¾ç‰‡
        self.direct_images = []  # å­˜å‚¨ç›´æ¥æ‹–å…¥çš„å›¾ç‰‡
        self.process_thread = None
        self.init_ui()
        self.load_sample_image_for_preview()
        self.update_live_preview()

    def load_sample_image_for_preview(self):
        """åŠ è½½ä¸€å¼ å†…ç½®çš„ç©ºç™½å›¾ç‰‡ä½œä¸ºé¢„è§ˆåŒºçš„èƒŒæ™¯ï¼Œæ–¹ä¾¿è°ƒè¯•æ°´å°å‚æ•°ã€‚"""
        try:
            sample_img = Image.new("RGB", (800, 600), color='#f0f0f0')
            draw = ImageDraw.Draw(sample_img)
            text = "é¢„è§ˆèƒŒæ™¯å›¾\n(æ”¯æŒæ‹–å…¥Wordæ–‡æ¡£æˆ–å›¾ç‰‡æ–‡ä»¶)\nå›¾ç‰‡å¯¼å‡ºè‡ªåŠ¨ä¿å­˜åˆ°ï¼šåŸæ–‡ä»¶å¤¹/å·²åŠ æ°´å°å›¾ç‰‡"
            try:
                font = ImageFont.truetype(get_default_font_path(), 24)
            except:
                font = ImageFont.load_default()
            try:
                bbox = draw.textbbox((0, 0), text, font=font)
                text_w = bbox[2] - bbox[0]
                text_h = bbox[3] - bbox[1]
            except:
                text_w, text_h = draw.textsize(text, font=font)
            draw.text(((800 - text_w) / 2, (600 - text_h) / 2), text, font=font, fill=(100, 100, 100))
            self.live_preview_label.set_image(sample_img)
        except Exception as e:
            self.log(f"åŠ è½½ç¤ºä¾‹å›¾ç‰‡å¤±è´¥: {e}")

    def update_live_preview(self):
        """æ ¹æ®å½“å‰å‚æ•°æ›´æ–°å·¦ä¾§çš„å®æ—¶é¢„è§ˆå›¾ã€‚"""
        current_settings = {
            "text": self.inp_text.text(),
            "size_percent": self.sl_size.value(),
            "opacity": self.sl_opacity.value(),
            "angle": self.sl_angle.value(),
            "color": self.config['color'],
            "fill_mode": self.cmb_fill_mode.currentData(),
            "offset_x": self.sl_offset_x.value(),
            "offset_y": self.sl_offset_y.value()
        }
        self.live_preview_label.set_settings(current_settings)

    def on_preview_offset_changed(self, offset_x, offset_y):
        """å½“æ‹–æ‹½é¢„è§ˆå›¾æ—¶ï¼ŒåŒæ­¥æ›´æ–°åç§»é‡æ»‘å—çš„å€¼ã€‚"""
        self.sl_offset_x.valueChanged.disconnect(self.update_live_preview)
        self.sl_offset_y.valueChanged.disconnect(self.update_live_preview)
        self.sl_offset_x.setValue(offset_x)
        self.sl_offset_y.setValue(offset_y)
        self.sl_offset_x.valueChanged.connect(self.update_live_preview)
        self.sl_offset_y.valueChanged.connect(self.update_live_preview)

    def set_color_ui(self, hex_color, update_config=True):
        if update_config:
            self.config['color'] = hex_color
        self.btn_color.setStyleSheet(f"text-align: left; color: {hex_color}; font-weight: bold;")
        self.update_live_preview()

    def show_color_menu(self):
        menu = QMenu(self)
        colors = {
            "ç°è‰²": "#808080",
            "çº¢è‰²": "#FF0000",
            "æ©™è‰²": "#FFA500",
            "è“è‰²": "#0000FF",
            "ç»¿è‰²": "#00FF00",
            "é»„è‰²": "#FFFF00",
            "é»‘è‰²": "#000000"
        }
        for name, hex_code in colors.items():
            action = QAction(f"{name} ({hex_code})", self)
            pixmap = QPixmap(16, 16)
            pixmap.fill(QColor(hex_code))
            action.setIcon(QIcon(pixmap))
            action.triggered.connect(lambda checked, h=hex_code: self.set_color_ui(h))
            menu.addAction(action)
        menu.addSeparator()
        picker_action = QAction("ğŸ¨ æ›´å¤šé¢œè‰²...", self)
        picker_action.triggered.connect(self.open_color_dialog)
        menu.addAction(picker_action)
        menu.exec(self.btn_color.mapToGlobal(QPoint(0, self.btn_color.height())))

    def open_color_dialog(self):
        color = QColorDialog.getColor(QColor(self.config['color']), self, "é€‰æ‹©æ°´å°é¢œè‰²")
        if color.isValid():
            self.set_color_ui(color.name())

    def init_ui(self):
        QApplication.setStyle("Fusion")
        w = QWidget()
        self.setCentralWidget(w)
        main_h_layout = QHBoxLayout(w)

        # --- å·¦ä¾§é¢æ¿ (å‚æ•°è®¾ç½® + å®æ—¶é¢„è§ˆ) ---
        left_panel = QWidget()
        left_v_layout = QVBoxLayout(left_panel)

        # æ¨¡å¼é€‰æ‹©
        mode_group = QGroupBox("å¤„ç†æ¨¡å¼")
        mode_layout = QHBoxLayout(mode_group)
        self.radio_word = QRadioButton("Wordæ–‡æ¡£å¤„ç†")
        self.radio_image = QRadioButton("å›¾ç‰‡æ–‡ä»¶å¤„ç†")
        self.radio_word.setChecked(True)  # é»˜è®¤Wordæ¨¡å¼
        mode_layout.addWidget(self.radio_word)
        mode_layout.addWidget(self.radio_image)
        left_v_layout.addWidget(mode_group)

        # å®æ—¶é¢„è§ˆåŒºåŸŸ
        preview_frame = QFrame()
        preview_frame.setFrameShape(QFrame.Shape.Box)
        preview_frame.setFrameShadow(QFrame.Shadow.Raised)
        preview_layout = QVBoxLayout(preview_frame)
        preview_layout.addWidget(QLabel("<b>å®æ—¶é¢„è§ˆ (æ‹–æ‹½æ°´å°è°ƒæ•´ä½ç½®):</b>"))
        self.live_preview_label = DraggablePreviewLabel()
        self.live_preview_label.setMinimumSize(280, 180)
        self.live_preview_label.offsetChanged.connect(self.on_preview_offset_changed)
        preview_layout.addWidget(self.live_preview_label)
        left_v_layout.addWidget(preview_frame)

        # å¯¼å‡ºè¯´æ˜ï¼ˆæ–°å¢ï¼‰
        export_note = QLabel(
            "<font color='green'>ğŸ“Œ å›¾ç‰‡æ¨¡å¼å¯¼å‡ºè¯´æ˜ï¼š</font><br/>è‡ªåŠ¨ä¿å­˜åˆ°åŸå›¾ç‰‡æ‰€åœ¨æ–‡ä»¶å¤¹çš„<br/><b>ã€Œå·²åŠ æ°´å°å›¾ç‰‡ã€</b> å­æ–‡ä»¶å¤¹")
        export_note.setStyleSheet("margin: 10px 0;")
        left_v_layout.addWidget(export_note)

        # å‚æ•°è®¾ç½®éƒ¨åˆ†
        settings_title = QLabel("âš™ï¸ å…¨å±€å‚æ•°è®¾ç½®")
        settings_title.setStyleSheet("font-weight: bold; font-size: 14pt;")
        left_v_layout.addWidget(settings_title)

        form = QFormLayout()
        self.inp_text = QLineEdit(self.config['text'])
        self.inp_text.textChanged.connect(self.update_live_preview)
        form.addRow("æ°´å°æ–‡å­—:", self.inp_text)

        self.sl_size = QSlider(Qt.Orientation.Horizontal)
        self.sl_size.setRange(1, 50)
        self.sl_size.setValue(self.config['size_percent'])
        self.sl_size.setToolTip("æ–‡å­—å®½åº¦å å›¾ç‰‡å®½åº¦çš„ç™¾åˆ†æ¯”")
        self.sl_size.valueChanged.connect(self.update_live_preview)
        form.addRow("å­—ä½“å¤§å° (1-50%):", self.sl_size)

        self.sl_opacity = QSlider(Qt.Orientation.Horizontal)
        self.sl_opacity.setRange(0, 100)
        self.sl_opacity.setValue(self.config['opacity'])
        self.sl_opacity.valueChanged.connect(self.update_live_preview)
        form.addRow("é€æ˜åº¦ (0-100%):", self.sl_opacity)

        self.sl_angle = QSlider(Qt.Orientation.Horizontal)
        self.sl_angle.setRange(0, 360)
        self.sl_angle.setValue(self.config['angle'])
        self.sl_angle.valueChanged.connect(self.update_live_preview)
        form.addRow("æ—‹è½¬è§’åº¦:", self.sl_angle)

        self.cmb_fill_mode = QComboBox()
        self.cmb_fill_mode.addItem("å•ä¸ª (å±…ä¸­)", "single")
        self.cmb_fill_mode.addItem("å¹³é“º (é‡å¤)", "tiled")
        idx = self.cmb_fill_mode.findData(self.config['fill_mode'])
        if idx != -1: self.cmb_fill_mode.setCurrentIndex(idx)
        self.cmb_fill_mode.currentTextChanged.connect(self.update_live_preview)
        form.addRow("å¡«å……æ¨¡å¼:", self.cmb_fill_mode)

        self.sl_offset_x = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_x.setRange(-200, 200)
        self.sl_offset_x.setValue(self.config['offset_x'])
        self.sl_offset_x.valueChanged.connect(self.update_live_preview)
        form.addRow("Xè½´åç§» (%):", self.sl_offset_x)

        self.sl_offset_y = QSlider(Qt.Orientation.Horizontal)
        self.sl_offset_y.setRange(-200, 200)
        self.sl_offset_y.setValue(self.config['offset_y'])
        self.sl_offset_y.valueChanged.connect(self.update_live_preview)
        form.addRow("Yè½´åç§» (%):", self.sl_offset_y)

        self.btn_color = QPushButton("é€‰æ‹©é¢œè‰² â– ")
        self.set_color_ui(self.config['color'], update_config=False)
        self.btn_color.clicked.connect(self.show_color_menu)
        form.addRow("æ–‡å­—é¢œè‰²:", self.btn_color)

        left_v_layout.addLayout(form)
        left_v_layout.addSpacing(20)

        # æ“ä½œæŒ‰é’®
        self.btn_apply = QPushButton("â–¶ åº”ç”¨æ°´å°åˆ°æ‰€æœ‰æ–‡ä»¶")
        self.btn_apply.setMinimumHeight(40)
        self.btn_apply.clicked.connect(self.run_batch_process)
        self.btn_apply.setEnabled(False)
        left_v_layout.addWidget(self.btn_apply)

        self.btn_export = QPushButton("ğŸ’¾ å¯¼å‡ºæ–‡ä»¶")
        self.btn_export.setMinimumHeight(40)
        self.btn_export.clicked.connect(self.export_files)
        self.btn_export.setEnabled(False)
        left_v_layout.addWidget(self.btn_export)

        left_v_layout.addStretch()

        # æ—¥å¿—åŒºåŸŸ
        left_v_layout.addWidget(QLabel("è¿è¡Œæ—¥å¿—:"))
        self.log_box = QPlainTextEdit()
        self.log_box.setReadOnly(True)
        self.log_box.setMaximumHeight(150)
        left_v_layout.addWidget(self.log_box)

        main_h_layout.addWidget(left_panel, stretch=1)

        # --- å³ä¾§é¢æ¿ (æ–‡ä»¶åˆ—è¡¨) ---
        right_panel = QWidget()
        right_v_layout = QVBoxLayout(right_panel)

        self.lbl_status = QLabel(
            "ğŸ“‚ è¯·å°† Wordæ–‡æ¡£ (.docx) æˆ–å›¾ç‰‡æ–‡ä»¶\n(PNG/JPG/BMPç­‰) æ‹–å…¥æ­¤å¤„\n\nå›¾ç‰‡å¯¼å‡ºè‡ªåŠ¨ä¿å­˜åˆ°ï¼šåŸæ–‡ä»¶å¤¹/å·²åŠ æ°´å°å›¾ç‰‡")
        self.lbl_status.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.lbl_status.setStyleSheet("border: 2px dashed #aaa; font-size: 16px; color: #555; padding: 40px;")
        right_v_layout.addWidget(self.lbl_status)

        self.list_widget = QListWidget()
        self.list_widget.setViewMode(QListWidget.ViewMode.IconMode)
        self.list_widget.setIconSize(QSize(150, 150))
        self.list_widget.setSpacing(10)
        self.list_widget.setMovement(QListWidget.Movement.Static)
        self.list_widget.setVisible(False)

        # å¯ç”¨å¤šé€‰æ¨¡å¼å’Œå³é”®èœå•
        self.list_widget.setSelectionMode(QListWidget.SelectionMode.ExtendedSelection)
        self.list_widget.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        self.list_widget.customContextMenuRequested.connect(self.on_list_context_menu)
        self.list_widget.itemDoubleClicked.connect(self.on_item_double_click)

        right_v_layout.addWidget(self.list_widget)

        self.progress = QProgressBar()
        self.progress.setVisible(False)
        right_v_layout.addWidget(self.progress)

        main_h_layout.addWidget(right_panel, stretch=2)

    def on_list_context_menu(self, position):
        """æ–‡ä»¶åˆ—è¡¨å³é”®èœå•"""
        selected_items = self.list_widget.selectedItems()
        if not selected_items:
            return

        menu = QMenu()

        # æ‰¹é‡ä¿®æ”¹æ°´å°
        action_modify = QAction("ä¿®æ”¹æ°´å°", self)
        action_modify.triggered.connect(self.batch_modify_watermark)
        menu.addAction(action_modify)

        # æ‰¹é‡ä¸åŠ æ°´å°
        action_no_watermark = QAction("ä¸åŠ æ°´å°", self)
        action_no_watermark.triggered.connect(self.batch_remove_watermark)
        menu.addAction(action_no_watermark)

        menu.exec(self.list_widget.mapToGlobal(position))

    def on_item_double_click(self, item):
        """åŒå‡»é¡¹ç›®è¿›è¡Œå•ç‹¬ç¼–è¾‘"""
        data = item.data(Qt.ItemDataRole.UserRole)
        if not data:
            return

        item_type, idx = data

        try:
            if item_type == 'word':
                # ç¼–è¾‘Wordæ–‡æ¡£ä¸­çš„å›¾ç‰‡
                word_item = self.image_parts[idx]
                base_settings = word_item['settings'] if word_item['settings'] else {
                    "text": self.inp_text.text(),
                    "size_percent": self.sl_size.value(),
                    "opacity": self.sl_opacity.value(),
                    "angle": self.sl_angle.value(),
                    "color": self.config['color'],
                    "fill_mode": self.cmb_fill_mode.currentData(),
                    "offset_x": self.sl_offset_x.value(),
                    "offset_y": self.sl_offset_y.value()
                }

                dlg = EditDialog(word_item['original'], base_settings, self)
                if dlg.exec():
                    new_settings = dlg.get_settings()
                    # ç«‹å³é‡æ–°å¤„ç†å¹¶æ›´æ–°
                    with io.BytesIO(word_item['original']) as bio:
                        pil_img = Image.open(bio)
                        res_pil = apply_watermark_to_image(pil_img, new_settings)
                        out_io = io.BytesIO()
                        res_pil.save(out_io, format="PNG")
                        word_item['processed'] = out_io.getvalue()
                        word_item['settings'] = new_settings

                    self.log(f"âœï¸ å·²å•ç‹¬ä¿®æ”¹ Wordå›¾ç‰‡ {idx + 1}")
                    self.update_file_list()

            elif item_type == 'image':
                # ç¼–è¾‘ç›´æ¥æ‹–å…¥çš„å›¾ç‰‡
                img_item = self.direct_images[idx]
                base_settings = img_item['settings'] if img_item['settings'] else {
                    "text": self.inp_text.text(),
                    "size_percent": self.sl_size.value(),
                    "opacity": self.sl_opacity.value(),
                    "angle": self.sl_angle.value(),
                    "color": self.config['color'],
                    "fill_mode": self.cmb_fill_mode.currentData(),
                    "offset_x": self.sl_offset_x.value(),
                    "offset_y": self.sl_offset_y.value()
                }

                # ç›´æ¥ä¼ é€’PILå›¾ç‰‡å¯¹è±¡
                with Image.open(io.BytesIO(img_item['original_data'])) as pil_img:
                    dlg = EditDialog(pil_img, base_settings, self)
                    if dlg.exec():
                        new_settings = dlg.get_settings()
                        # ç«‹å³é‡æ–°å¤„ç†å¹¶æ›´æ–°
                        with Image.open(io.BytesIO(img_item['original_data'])) as pil_img:
                            res_pil = apply_watermark_to_image(pil_img, new_settings)
                            out_io = io.BytesIO()
                            res_pil.save(out_io, format="PNG")
                            img_item['processed_data'] = out_io.getvalue()
                            img_item['settings'] = new_settings

                        self.log(f"âœï¸ å·²å•ç‹¬ä¿®æ”¹å›¾ç‰‡: {os.path.basename(img_item['original_path'])}")
                        self.update_file_list()

        except Exception as e:
            self.log(f"âŒ å•ç‹¬ç¼–è¾‘å¤±è´¥: {str(e)}")
            QMessageBox.warning(self, "ç¼–è¾‘å¤±è´¥", f"ä¿®æ”¹å›¾ç‰‡æ—¶å‡ºé”™: {str(e)}")

    def batch_modify_watermark(self):
        """æ‰¹é‡ä¿®æ”¹é€‰ä¸­å›¾ç‰‡çš„æ°´å°è®¾ç½®"""
        selected_items = self.list_widget.selectedItems()
        if not selected_items:
            return

        # ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰ä¸­å›¾ç‰‡ä½œä¸ºé¢„è§ˆ
        first_item_data = selected_items[0].data(Qt.ItemDataRole.UserRole)
        if not first_item_data:
            return

        item_type, idx = first_item_data
        preview_image = None

        try:
            if item_type == 'word':
                preview_image = Image.open(io.BytesIO(self.image_parts[idx]['original']))
            else:
                preview_image = Image.open(io.BytesIO(self.direct_images[idx]['original_data']))
        except Exception as e:
            self.log(f"âš ï¸ åŠ è½½é¢„è§ˆå›¾ç‰‡å¤±è´¥: {e}")
            return

        # æ‰“å¼€æ‰¹é‡ç¼–è¾‘å¯¹è¯æ¡†
        current_settings = {
            "text": self.inp_text.text(),
            "size_percent": self.sl_size.value(),
            "opacity": self.sl_opacity.value(),
            "angle": self.sl_angle.value(),
            "color": self.config['color'],
            "fill_mode": self.cmb_fill_mode.currentData(),
            "offset_x": self.sl_offset_x.value(),
            "offset_y": self.sl_offset_y.value()
        }

        dlg = BatchEditDialog(preview_image, current_settings, self)
        if dlg.exec():
            new_settings = dlg.get_settings()

            # ç«‹å³åº”ç”¨åˆ°æ‰€æœ‰é€‰ä¸­çš„å›¾ç‰‡å¹¶é‡æ–°å¤„ç†
            processed_count = 0
            for item in selected_items:
                data = item.data(Qt.ItemDataRole.UserRole)
                if not data:
                    continue

                item_type, idx = data
                try:
                    if item_type == 'word':
                        # ç«‹å³é‡æ–°å¤„ç†è¯¥å›¾ç‰‡
                        with io.BytesIO(self.image_parts[idx]['original']) as bio:
                            pil_img = Image.open(bio)
                            res_pil = apply_watermark_to_image(pil_img, new_settings)
                            out_io = io.BytesIO()
                            res_pil.save(out_io, format="PNG")
                            self.image_parts[idx]['processed'] = out_io.getvalue()
                            self.image_parts[idx]['settings'] = new_settings

                        self.log(f"âœï¸ æ‰¹é‡ä¿®æ”¹ Wordå›¾ç‰‡ {idx + 1}")
                    else:
                        # ç«‹å³é‡æ–°å¤„ç†è¯¥å›¾ç‰‡
                        with Image.open(io.BytesIO(self.direct_images[idx]['original_data'])) as pil_img:
                            res_pil = apply_watermark_to_image(pil_img, new_settings)
                            out_io = io.BytesIO()
                            res_pil.save(out_io, format="PNG")
                            self.direct_images[idx]['processed_data'] = out_io.getvalue()
                            self.direct_images[idx]['settings'] = new_settings

                        self.log(f"âœï¸ æ‰¹é‡ä¿®æ”¹: {os.path.basename(self.direct_images[idx]['original_path'])}")

                    # ç§»é™¤è·³è¿‡æ°´å°æ ‡è®°
                    if " [ä¸åŠ æ°´å°]" in item.text():
                        item.setText(item.text().replace(" [ä¸åŠ æ°´å°]", ""))

                    processed_count += 1

                except Exception as e:
                    self.log(f"âš ï¸ å¤„ç†å¤±è´¥ {item.text()}: {e}")

            self.log(f"âœ… å·²æ‰¹é‡ä¿®æ”¹ {processed_count} å¼ å›¾ç‰‡çš„æ°´å°è®¾ç½®")
            self.update_file_list()

    def batch_remove_watermark(self):
        """æ‰¹é‡ç§»é™¤é€‰ä¸­å›¾ç‰‡çš„æ°´å°ï¼ˆæ¢å¤ä¸ºåŸå›¾ï¼‰"""
        selected_items = self.list_widget.selectedItems()
        if not selected_items:
            return

        for item in selected_items:
            data = item.data(Qt.ItemDataRole.UserRole)
            if not data:
                continue

            item_type, idx = data
            # è®¾ç½®è·³è¿‡æ°´å°æ ‡è®°
            skip_settings = {"skip_watermark": True}

            if item_type == 'word':
                self.image_parts[idx]['settings'] = skip_settings
                # ç«‹å³æ¢å¤ä¸ºåŸå§‹æ•°æ®
                self.image_parts[idx]['processed'] = self.image_parts[idx]['original']
            else:
                self.direct_images[idx]['settings'] = skip_settings
                # ç«‹å³æ¢å¤ä¸ºåŸå§‹æ•°æ®
                self.direct_images[idx]['processed_data'] = self.direct_images[idx]['original_data']

            # æ·»åŠ è§†è§‰æ ‡è®°
            if " [ä¸åŠ æ°´å°]" not in item.text():
                item.setText(item.text() + " [ä¸åŠ æ°´å°]")

        self.log(f"âœ… å·²æ‰¹é‡è®¾ç½® {len(selected_items)} å¼ å›¾ç‰‡: ä¸åŠ æ°´å°")
        self.update_file_list()

    def log(self, msg):
        """æ·»åŠ æ—¥å¿—"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        self.log_box.appendPlainText(f"[{timestamp}] {msg}")
        self.log_box.verticalScrollBar().setValue(self.log_box.verticalScrollBar().maximum())
        QApplication.processEvents()

    def dragEnterEvent(self, e: QDragEnterEvent):
        """æ‹–æ‹½è¿›å…¥äº‹ä»¶"""
        if e.mimeData().hasUrls():
            e.accept()
        else:
            e.ignore()

    def dropEvent(self, e: QDropEvent):
        """æ‹–æ‹½é‡Šæ”¾äº‹ä»¶"""
        urls = e.mimeData().urls()
        if not urls:
            return

        # å¤„ç†æ‰€æœ‰æ‹–æ‹½çš„æ–‡ä»¶
        file_paths = [url.toLocalFile() for url in urls]
        word_files = []
        image_files = []

        for path in file_paths:
            if path.endswith(".docx"):
                word_files.append(path)
            elif is_supported_image(path):
                image_files.append(path)
            else:
                self.log(f"âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: {os.path.basename(path)}")

        # ä¼˜å…ˆå¤„ç†Wordæ–‡æ¡£ï¼ˆä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªï¼‰
        if word_files:
            self.load_doc(word_files[0])
            if len(word_files) > 1:
                self.log(f"âš ï¸ ä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªWordæ–‡æ¡£ï¼Œå·²å¿½ç•¥å…¶ä»– {len(word_files) - 1} ä¸ª")

        # å¤„ç†å›¾ç‰‡æ–‡ä»¶
        if image_files:
            self.load_images(image_files)

    def load_doc(self, path):
        """åŠ è½½Wordæ–‡æ¡£"""
        self.radio_word.setChecked(True)
        self.doc_path = path
        self.direct_images = []  # æ¸…ç©ºå›¾ç‰‡åˆ—è¡¨
        self.log(f"ğŸ“¥ æ­£åœ¨åŠ è½½Wordæ–‡æ¡£: {os.path.basename(path)}")
        self.lbl_status.setText("æ­£åœ¨åˆ†ææ–‡æ¡£ä¸­çš„å›¾ç‰‡...")
        self.lbl_status.setVisible(True)
        self.list_widget.setVisible(False)
        QApplication.processEvents()

        try:
            self.doc = Document(path)
            self.image_parts = []
            count = 0
            for rel in self.doc.part.rels.values():
                if "image" in rel.target_ref:
                    part = rel.target_part
                    self.image_parts.append({
                        "type": "word",
                        "part": part,
                        "original": part.blob,
                        "processed": part.blob,
                        "settings": None
                    })
                    count += 1

            if count == 0:
                self.log("âš ï¸ æ–‡æ¡£ä¸­æœªå‘ç°å›¾ç‰‡ã€‚")
                self.lbl_status.setText("æ–‡æ¡£æ— å›¾ç‰‡")
                return

            self.log(f"âœ… æˆåŠŸæ£€æµ‹åˆ° {count} å¼ å›¾ç‰‡ (æ¥è‡ªWordæ–‡æ¡£)")
            self.lbl_status.setVisible(False)
            self.list_widget.setVisible(True)
            self.btn_apply.setEnabled(True)
            self.btn_export.setEnabled(True)
            self.update_file_list()

        except Exception as e:
            self.log(f"âŒ è¯»å–Wordæ–‡æ¡£å¤±è´¥: {str(e)}")
            self.lbl_status.setText("è¯»å–Wordæ–‡æ¡£å¤±è´¥")

    def load_images(self, paths):
        """åŠ è½½ç›´æ¥æ‹–å…¥çš„å›¾ç‰‡"""
        self.radio_image.setChecked(True)
        self.doc = None  # æ¸…ç©ºWordæ–‡æ¡£
        self.image_parts = []  # æ¸…ç©ºWordå›¾ç‰‡åˆ—è¡¨
        self.log(f"ğŸ“¥ æ­£åœ¨åŠ è½½å›¾ç‰‡æ–‡ä»¶: å…± {len(paths)} å¼ ")
        self.lbl_status.setText("æ­£åœ¨åŠ è½½å›¾ç‰‡...")
        self.lbl_status.setVisible(True)
        self.list_widget.setVisible(False)
        QApplication.processEvents()

        try:
            # ä¿å­˜å›¾ç‰‡ä¿¡æ¯
            self.direct_images = []
            for path in paths:
                with open(path, 'rb') as f:
                    original_data = f.read()

                self.direct_images.append({
                    "type": "image",
                    "original_path": path,
                    "original_data": original_data,
                    "processed_data": original_data,
                    "format": "PNG",  # å¼ºåˆ¶è®¾ç½®ä¸ºPNG
                    "settings": None
                })

            self.log(f"âœ… æˆåŠŸåŠ è½½ {len(self.direct_images)} å¼ å›¾ç‰‡")
            self.lbl_status.setVisible(False)
            self.list_widget.setVisible(True)
            self.btn_apply.setEnabled(True)
            self.btn_export.setEnabled(True)
            self.update_file_list()

        except Exception as e:
            self.log(f"âŒ åŠ è½½å›¾ç‰‡å¤±è´¥: {str(e)}")
            self.lbl_status.setText("åŠ è½½å›¾ç‰‡å¤±è´¥")

    def update_file_list(self):
        """æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º"""
        self.list_widget.clear()

        # æ˜¾ç¤ºWordæ–‡æ¡£ä¸­çš„å›¾ç‰‡
        for i, item in enumerate(self.image_parts):
            try:
                # ç”Ÿæˆé¢„è§ˆå›¾
                with Image.open(io.BytesIO(item['processed'])) as pil_img:
                    thumb = pil_img.copy()
                    thumb.thumbnail((200, 200))
                    thumb_io = io.BytesIO()
                    thumb.save(thumb_io, format="PNG")

                    qt_img = QImage.fromData(thumb_io.getvalue())
                    pix = QPixmap.fromImage(qt_img)
                    list_item = QListWidgetItem(QIcon(pix), f"Wordå›¾ç‰‡ {i + 1}")
                    if isinstance(item.get('settings'), dict) and item['settings'].get('skip_watermark'):
                        list_item.setText(list_item.text() + " [ä¸åŠ æ°´å°]")
                    list_item.setData(Qt.ItemDataRole.UserRole, ('word', i))
                    self.list_widget.addItem(list_item)
            except Exception as e:
                self.log(f"âš ï¸ ç”Ÿæˆé¢„è§ˆå¤±è´¥ (Wordå›¾ç‰‡ {i + 1}): {e}")

        # æ˜¾ç¤ºç›´æ¥æ‹–å…¥çš„å›¾ç‰‡
        for i, item in enumerate(self.direct_images):
            try:
                # ç”Ÿæˆé¢„è§ˆå›¾
                with Image.open(io.BytesIO(item['processed_data'])) as pil_img:
                    thumb = pil_img.copy()
                    thumb.thumbnail((200, 200))
                    thumb_io = io.BytesIO()
                    thumb.save(thumb_io, format="PNG")

                    qt_img = QImage.fromData(thumb_io.getvalue())
                    pix = QPixmap.fromImage(qt_img)
                    filename = os.path.basename(item['original_path'])
                    list_item = QListWidgetItem(QIcon(pix), filename)
                    if isinstance(item.get('settings'), dict) and item['settings'].get('skip_watermark'):
                        list_item.setText(list_item.text() + " [ä¸åŠ æ°´å°]")
                    list_item.setData(Qt.ItemDataRole.UserRole, ('image', i))
                    self.list_widget.addItem(list_item)
            except Exception as e:
                self.log(f"âš ï¸ ç”Ÿæˆé¢„è§ˆå¤±è´¥ ({os.path.basename(item['original_path'])}): {e}")

    def run_batch_process(self):
        """æ‰¹é‡åº”ç”¨æ°´å°"""
        # è·å–å½“å‰å…¨å±€è®¾ç½®
        global_settings = {
            "text": self.inp_text.text(),
            "size_percent": self.sl_size.value(),
            "opacity": self.sl_opacity.value(),
            "angle": self.sl_angle.value(),
            "color": self.config['color'],
            "fill_mode": self.cmb_fill_mode.currentData(),
            "offset_x": self.sl_offset_x.value(),
            "offset_y": self.sl_offset_y.value()
        }
        self.config.update(global_settings)
        save_config(self.config)

        self.log("â³ å¼€å§‹æ‰¹é‡åº”ç”¨æ°´å°...")
        self.progress.setVisible(True)
        self.btn_apply.setEnabled(False)
        self.btn_export.setEnabled(False)

        # æ ¹æ®å½“å‰æ¨¡å¼å¤„ç†
        if self.radio_word.isChecked() and self.image_parts:
            # å¤„ç†Wordæ–‡æ¡£ä¸­çš„å›¾ç‰‡
            total = len(self.image_parts)
            self.progress.setRange(0, total)

            for i, item in enumerate(self.image_parts):
                self.progress.setValue(i)
                current_settings = item['settings'] if item['settings'] else global_settings

                try:
                    with io.BytesIO(item['original']) as bio:
                        pil_img = Image.open(bio)
                        res_pil = apply_watermark_to_image(pil_img, current_settings)
                        out_io = io.BytesIO()
                        # å¼ºåˆ¶PNGæ ¼å¼
                        res_pil.save(out_io, format="PNG")
                        item['processed'] = out_io.getvalue()
                except Exception as e:
                    self.log(f"âš ï¸ å¤„ç†å¤±è´¥ (Wordå›¾ç‰‡ {i + 1}): {e}")

            self.progress.setValue(total)
            self.log("âœ… Wordæ–‡æ¡£å›¾ç‰‡æ°´å°åº”ç”¨å®Œæˆ")
            self.update_file_list()
            self.btn_export.setEnabled(True)

        elif self.radio_image.isChecked() and self.direct_images:
            # å¤„ç†ç›´æ¥æ‹–å…¥çš„å›¾ç‰‡ï¼ˆä½¿ç”¨çº¿ç¨‹é¿å…UIé˜»å¡ï¼‰
            image_paths = [item['original_path'] for item in self.direct_images]
            self.process_thread = ImageProcessThread(image_paths, global_settings)
            self.process_thread.progress_update.connect(self.on_process_progress)
            self.process_thread.finished_signal.connect(self.on_image_process_finished)
            self.process_thread.error_signal.connect(self.log)
            self.process_thread.start()

        self.progress.setVisible(False)

    @pyqtSlot(int)
    def on_process_progress(self, value):
        """å›¾ç‰‡å¤„ç†è¿›åº¦æ›´æ–°"""
        self.progress.setRange(0, 100)
        self.progress.setValue(value)

    @pyqtSlot(list)
    def on_image_process_finished(self, processed_images):
        """å›¾ç‰‡å¤„ç†çº¿ç¨‹å®Œæˆ"""
        self.direct_images = processed_images
        self.log("âœ… ç›´æ¥æ‹–å…¥å›¾ç‰‡æ°´å°åº”ç”¨å®Œæˆ")
        self.update_file_list()
        self.btn_apply.setEnabled(True)
        self.btn_export.setEnabled(True)
        self.progress.setVisible(False)

    def export_files(self):
        """å¯¼å‡ºæ–‡ä»¶"""
        if self.radio_word.isChecked() and self.doc and self.image_parts:
            # Wordæ–‡æ¡£å¯¼å‡ºä¿æŒåŸæœ‰é€»è¾‘ï¼ˆä»éœ€é€‰æ‹©è·¯å¾„ï¼‰
            default_name = os.path.splitext(self.doc_path)[0] + "_æ°´å°ç‰ˆ.docx"
            path, _ = QFileDialog.getSaveFileName(self, "ä¿å­˜Wordæ–‡æ¡£", default_name, "Word Documents (*.docx)")

            if path:
                self.log(f"ğŸ’¾ æ­£åœ¨ä¿å­˜Wordæ–‡æ¡£: {os.path.basename(path)}")
                try:
                    for item in self.image_parts:
                        item['part']._blob = item['processed']
                    self.doc.save(path)
                    self.log("ğŸ‰ Wordæ–‡æ¡£å¯¼å‡ºæˆåŠŸï¼")
                    QMessageBox.information(self, "å¯¼å‡ºæˆåŠŸ", f"Wordæ–‡æ¡£å·²ä¿å­˜è‡³:\n{path}")
                except Exception as e:
                    self.log(f"âŒ Wordæ–‡æ¡£ä¿å­˜å¤±è´¥: {e}")
                    QMessageBox.critical(self, "ä¿å­˜å¤±è´¥", str(e))

        elif self.radio_image.isChecked() and self.direct_images:
            # å›¾ç‰‡å¯¼å‡ºï¼šè‡ªåŠ¨ä¿å­˜åˆ°åŸæ–‡ä»¶å¤¹çš„ã€Œå·²åŠ æ°´å°å›¾ç‰‡ã€ç›®å½•ï¼Œå¼ºåˆ¶PNGæ ¼å¼
            self.log("ğŸ’¾ å¼€å§‹å¯¼å‡ºå›¾ç‰‡ï¼ˆè‡ªåŠ¨ä¿å­˜åˆ°åŸæ–‡ä»¶å¤¹/å·²åŠ æ°´å°å›¾ç‰‡ï¼Œæ ¼å¼ï¼šPNGï¼‰...")
            self.progress.setVisible(True)
            self.progress.setRange(0, len(self.direct_images))

            success_count = 0
            failed_files = []
            output_dirs = set()  # è®°å½•æ‰€æœ‰è¾“å‡ºç›®å½•ï¼Œæ–¹ä¾¿æœ€åæ‰“å¼€

            for i, img_item in enumerate(self.direct_images):
                self.progress.setValue(i)
                try:
                    # æ£€æŸ¥æ˜¯å¦è·³è¿‡æ°´å°
                    settings = img_item.get('settings')
                    skip_watermark = isinstance(settings, dict) and settings.get('skip_watermark', False)

                    if skip_watermark:
                        processed_data = img_item['original_data']
                        self.log(f"â­ï¸ è·³è¿‡æ°´å°: {os.path.basename(img_item['original_path'])}")
                    else:
                        processed_data = img_item['processed_data']

                    # è·å–åŸå›¾ç‰‡çš„ç›®å½•å’Œæ–‡ä»¶å
                    original_path = img_item['original_path']
                    original_dir = os.path.dirname(original_path)
                    filename_without_ext = os.path.splitext(os.path.basename(original_path))[0]

                    # åˆ›å»ºè¾“å‡ºç›®å½•ï¼šåŸç›®å½•/å·²åŠ æ°´å°å›¾ç‰‡
                    output_dir = os.path.join(original_dir, "å·²åŠ æ°´å°å›¾ç‰‡")
                    os.makedirs(output_dir, exist_ok=True)  # ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå­˜åœ¨åˆ™å¿½ç•¥
                    output_dirs.add(output_dir)

                    # æ„å»ºè¾“å‡ºæ–‡ä»¶åï¼šåŸæ–‡ä»¶å_æ°´å°.png ï¼ˆå¼ºåˆ¶PNGæ‰©å±•åï¼‰
                    output_filename = f"{filename_without_ext}_æ°´å°.png"
                    output_path = os.path.join(output_dir, output_filename)

                    # é¿å…æ–‡ä»¶åé‡å¤ï¼ˆå¦‚æœå·²å­˜åœ¨åˆ™æ·»åŠ æ—¶é—´æˆ³ï¼‰
                    if os.path.exists(output_path):
                        timestamp = datetime.now().strftime("%H%M%S")
                        output_filename = f"{filename_without_ext}_æ°´å°_{timestamp}.png"
                        output_path = os.path.join(output_dir, output_filename)

                    # ä¿å­˜å›¾ç‰‡
                    with open(output_path, 'wb') as f:
                        f.write(processed_data)

                    success_count += 1
                    self.log(f"âœ… ä¿å­˜æˆåŠŸ: {os.path.basename(output_path)}")

                except Exception as e:
                    err_msg = f"å›¾ç‰‡ {os.path.basename(img_item['original_path'])}: {str(e)}"
                    self.log(f"âš ï¸ ä¿å­˜å¤±è´¥: {err_msg}")
                    failed_files.append(err_msg)

            self.progress.setValue(len(self.direct_images))
            self.progress.setVisible(False)

            # å¯¼å‡ºç»“æœæç¤º
            result_msg = f"ğŸ‰ å›¾ç‰‡å¯¼å‡ºå®Œæˆï¼\n\næˆåŠŸä¿å­˜ {success_count}/{len(self.direct_images)} å¼ å›¾ç‰‡\n\nè¾“å‡ºç›®å½•ï¼š"
            for dir_path in output_dirs:
                result_msg += f"\nâ€¢ {dir_path}"

            if failed_files:
                result_msg += f"\n\nâš ï¸ å¤±è´¥æ–‡ä»¶ ({len(failed_files)} ä¸ª):"
                for err in failed_files[:5]:  # åªæ˜¾ç¤ºå‰5ä¸ªå¤±è´¥ä¿¡æ¯
                    result_msg += f"\nâ€¢ {err}"
                if len(failed_files) > 5:
                    result_msg += f"\nâ€¢ è¿˜æœ‰ {len(failed_files) - 5} ä¸ªæ–‡ä»¶ä¿å­˜å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"

            QMessageBox.information(self, "å›¾ç‰‡å¯¼å‡ºæˆåŠŸ", result_msg)

            # è‡ªåŠ¨æ‰“å¼€ç¬¬ä¸€ä¸ªè¾“å‡ºç›®å½•ï¼ˆå¦‚æœæœ‰ï¼‰
            if output_dirs:
                first_dir = next(iter(output_dirs))
                if platform.system() == "Windows":
                    os.startfile(first_dir)
                elif platform.system() == "Darwin":
                    os.system(f"open {first_dir}")
                else:
                    os.system(f"xdg-open {first_dir}")


if __name__ == "__main__":
    app = QApplication(sys.argv)
    win = MainWindow()
    win.show()
    sys.exit(app.exec())